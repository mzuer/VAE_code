
# Rscript nd_result_exploration_ov.R

require(ggplot2)

require(viridis)

outFolder <- file.path("ND_RESULT_EXPLORATION_OV")
dir.create(outFolder, recursive = TRUE)

plotType <- "png"
myHeight <- 400
myWidth <- 400

indata_file <- file.path('/home/marie/Documents/FREITAS_LAB/VAE_tutos/NeuralDec/ovarian_data/log_filtNormCount_mostVar_dt.txt')
vae_latent_repr_file <- file.path("ND_OV_TCGA_GTEX_MRNA/mu_z_hd32_nLD1_cnormtum_25000_100_15_0-1_0-1.csv")
corr_file <- file.path("ND_OV_TCGA_GTEX_MRNA/correlations_all_hd32_nLD1_cnormtum_25000_100_15_0-1_0-1.csv")
corrpval_file <- file.path("ND_OV_TCGA_GTEX_MRNA/p_values_all_hd32_nLD1_cnormtum_25000_100_15_0-1_0-1.csv")
annot_file <- file.path('/home/marie/Documents/FREITAS_LAB/VAE_tutos/NeuralDec/ovarian_data/tcga_annot_dt.txt')

source("../../ovarian_project/phenopath/phenopath_my_utils.R")

annot_dt <- read.delim(annot_file, sep=",", header=T, stringsAsFactors = FALSE)

# tcga_annot_dt <- get(load("../../ovarian_project/tcga_data//DOWNLOAD_TCGA_GTEX_OV_RECOUNT2/tcga_sampleAnnot.Rdata"))
# # annot_dt <- read.delim(annot_file, header=T, stringsAsFactors = FALSE, sep=",")
# unique(tcga_annot_dt$cgc_case_clinical_stage)
# annot_dt <- tcga_annot_dt


in_dt <- read.delim(indata_file, header=T, stringsAsFactors = FALSE, sep=",", check.names = FALSE)
dim(in_dt)
expr_dt <- in_dt
expr_dt$geneID_symb <- expr_dt$geneID_ensembl <- NULL
# 1000x525
stopifnot(!duplicated(in_dt$gene_symbol))
stopifnot(!duplicated(in_dt$ensembl_id))
exprT_dt <- t(expr_dt)
nSamp <- ncol(expr_dt)

nGTEX <- sum(grepl("^GTEX", colnames(expr_dt)))
nTCGA <- sum(grepl("^TCGA", colnames(expr_dt)))
stopifnot(nTCGA + nGTEX == ncol(expr_dt))

# rownames(annot_dt) <- annot_dt$Tumor.ID
rownames(annot_dt) <- annot_dt$cgc_case_id
stopifnot(setequal(rownames(annot_dt), colnames(expr_dt)))
annot_dt <- annot_dt[colnames(expr_dt),]
annot_dt$PAM50.subtype <- as.factor(annot_dt$PAM50.subtype)
col_lab <- "PAM50.subtype"


vae_lr_dt <- read.delim(vae_latent_repr_file, header=F, stringsAsFactors = FALSE, sep=",")
dim(vae_lr_dt)
# 525x1
rownames(vae_lr_dt) <- colnames(expr_dt)
# 45x100
ov_pseudotimes <- setNames(vae_lr_dt[,1], rownames(vae_lr_dt))

corr_dt <- read.delim(corrpval_file, header=F, stringsAsFactors = FALSE, sep=",")
dim(corr_dt)
rownames(corr_dt) <- in_dt$gene_symbol
# 1000  100

pval_dt <- read.delim(corrpval_file, header=F, stringsAsFactors = FALSE, sep=",")
dim(pval_dt)
rownames(pval_dt) <- in_dt$gene_symbol
# 1000  100




############## PC dots with color-coded by pseudotime gradient ##############
################################### 

myannot_dt <- annot_dt[,c("labs_for_purity", "cgc_case_clinical_stage")]
myannot_dt$labs_for_purity <- gsub("-", ".", myannot_dt$labs_for_purity)
stopifnot(any(colnames(expr_dt) %in% myannot_dt$labs_for_purity))
stopifnot(!duplicated(myannot_dt$labs_for_purity))
labs2stage <- setNames(myannot_dt$cgc_case_clinical_stage, myannot_dt$labs_for_purity)

all_annot_dt <- data.frame(
  sampleID = colnames(expr_dt),
  annot =NA,
  stringsAsFactors = FALSE
)
all_annot_dt$annot <- labs2stage[all_annot_dt$sampleID]
all_annot_dt$annot[grep("GTEX", all_annot_dt$sampleID)] <- "norm"
stopifnot(sum(na.omit(all_annot_dt$annot) == "norm" ) == nGTEX)

all_annot_dt$ov_pseudotimes <- ov_pseudotimes[all_annot_dt$sampleID]

stopifnot(!is.na(all_annot_dt$ov_pseudotimes))


ggplot(data=all_annot_dt, aes(x=annot, y=ov_pseudotimes))+
  geom_boxplot()


pca_ov <- prcomp(exprT_dt, scale=TRUE)
pca_ov_lowrepr <- pca_ov$x
stopifnot(nrow(pca_ov_lowrepr) == nGTEX+nTCGA)


p <- pcaplot_gg2(pca_dt=data.frame(pca_ov_lowrepr), pctoplot=c(2,3), summ_dt=summary(pca_ov),
                 condvect = gsub("(^.+?)\\..+", "\\1", rownames(pca_ov_lowrepr)),
                 colvect=ov_pseudotimes,
                 mytit = paste0("TCGA+GTEX OV ND input data"),
                 mysubtit = paste0("nGTEX=",nGTEX, "; nTCGA=",nTCGA))

outFile <- file.path(outFolder, paste0("in_raw_data_pca_23_pseudotimeGrad_tcga_gtex.", plotType))
ggsave(p, filename = outFile, height=myHeightGG*0.9, width=myWidthGG*1.5)
cat(paste0("... written: ", outFile, "\n"))


p <- pcaplot_gg2(pca_dt=data.frame(pca_ov_lowrepr), pctoplot=c(1,2), summ_dt=summary(pca_ov),
                 condvect = gsub("(^.+?)-.+", "\\1", rownames(pca_ov_lowrepr)),
                 colvect=ov_pseudotimes,
                 mytit = paste0("TCGA+GTEX OV notNorm (log2(.+1))"),
                 mysubtit = paste0("nGTEX=",nGTEX, "; nTCGA=",nTCGA))

outFile <- file.path(outFolder, paste0("in_raw_data_pca_12_pseudotimeGrad_tcga_gtex.", plotType))
ggsave(p, filename = outFile, height=myHeightGG*0.9, width=myWidthGG*1.5)
cat(paste0("... written: ", outFile, "\n"))



p <- pcaplot_gg2(pca_dt=data.frame(pca_ov_lowrepr), pctoplot=c(1,3), summ_dt=summary(pca_ov),
                 condvect = gsub("(^.+?)-.+", "\\1", rownames(pca_ov_lowrepr)),
                 colvect=ov_pseudotimes,
                 mytit = paste0("TCGA+GTEX OV notNorm (log2(.+1))"),
                 mysubtit = paste0("nGTEX=",nGTEX, "; nTCGA=",nTCGA))

outFile <- file.path(outFolder, paste0("in_raw_data_pca_13_pseudotimeGrad_tcga_gtex.", plotType))
ggsave(p, filename = outFile, height=myHeightGG*0.9, width=myWidthGG*1.5)
cat(paste0("... written: ", outFile, "\n"))


################################### 
# look at how it compares with phenopath results
require(phenopath)
pheno_indt <- get(load("../../ovarian_project/phenopath/PHENOPATH_RECOUNT2_TCGA_OV/ov_data_filtered.Rdata"))
pheno_pt <- get(load("../../ovarian_project/phenopath/PHENOPATH_RECOUNT2_TCGA_OV/ov_phenopath_fit.Rdata"))
pheno_traj <- trajectory(pheno_pt)
stopifnot(ncol(pheno_indt) == length(pheno_traj))

names(pheno_traj) <- colnames(pheno_indt)

stopifnot(setequal(names(ov_pseudotimes), names(pheno_traj)))

plot(
  x = ov_pseudotimes,
  y = pheno_traj[names(ov_pseudotimes)],
  col = as.numeric(grepl("TCGA", names(ov_pseudotimes))) +1, 
  cex=0.7
)
foo <- dev.off()
cat(paste0("... written: ", outFolder, "\n"))



################################### 
# look correlations with stages


all_traj <- setNames(ov_pseudotimes, rownames(ov_data_filteredT))
stopifnot(names(all_traj) == c(gtex_annot_dt$sampid, tcga_annot_dt$cgc_sample_id))

############### TCGA data
stopifnot(tcga_annot_dt$gdc_cases.samples.sample_type == tcga_annot_dt$cgc_sample_sample_type)

# > cgc_case_age_at_diagnosis
# Error: object 'cgc_case_age_at_diagnosis' not found
# > cgc_case_days_to_death
# Error: object 'cgc_case_days_to_death' not found
# > cgc_case_clinical_stage
# > cgc_durg_therapy_drug_name
# # Error: object 'cgc_durg_therapy_drug_name' not found -> too many
# > cgc_follow_up_days_to_deathg
# Error: object 'cgc_follow_up_days_to_deathg' not found
# > histologic name and gdc_cases.project .name grep serous
# Error: unexpected symbol in "histologic name"
# > sampletypeID


myplotlab <- "tumor stage"
stg_ords <-c(  "Stage IC", "Stage IIA" ,"Stage IIB" , "Stage IIC","Stage IIIA", "Stage IIIB","Stage IIIC",   "Stage IV")
p <- plot_pheno_catego(tcga_annot_dt,  pt_traj = all_traj, plotvar= "cgc_case_clinical_stage", plotxlab=paste0("TCGA HGSC ", myplotlab), varords=stg_ords)
outFile <- file.path(outFolder, paste0("boxplot_pseudotimes_by_", paste0(gsub(" ", "_",myplotlab)),"_TCGA.", plotType))
ggsave(plot = p, filename = outFile, height=myHeightGG, width = myWidthGG)
cat(paste0("... written: ", outFile, "\n"))









stop("--ok\n")

############## gene set enrichment on top and bottom beta value genes ##############


outFile <- file.path(outFolder, paste0("pca_", "GTEX_TCGA_OV", "_mostVar.", plotType))
do.call(plotType, list(outFile, height=myHeight, width=myWidth))
plot(x = pca_data_lowrepr[,1],
     y = pca_data_lowrepr[,2],
     xlab="PC1", ylab="PC2",
     main=paste0(data_in),
     pch=16,
     col=as.numeric(annot_dt[,paste0(col_lab)]))
mtext(text=paste0("# samp=",nSamp), side=3)
legend("topleft", legend=as.character(levels(annot_dt[,paste0(col_lab)])),
       pch=16, 
       col=as.numeric(unique(annot_dt[,paste0(col_lab)])), 
       bty="n")
foo <- dev.off()
cat(paste0("... written: ", outFile, "\n"))




















require(recount)
require(TCGAbiolinks)
require(biomaRt)
require(phenopath)
require(ggplot2)
require(ggrepel)
require(ggsci)
require(viridis)
require(dplyr)
require(limma)
require(plyr)
require(edgeR)
require(matrixStats)
require(goseq)
require(mclust)
require(ggExtra)
require(ReactomePA)
require(reactome.db)
require(AnnotationDbi)
require(org.Hs.eg.db)
require(tidyr)

genome <- "hg19"
id <- "ensGene"
go_cat <- "GO:BP"
plotNgos <- 10
topCorrThresh <- 0.5  # 0.5 in Campbell and Yau 2018; to select most corr. for GO enrichment
topBetaThresh <- 0.5  # 0.5 in Campbell and Yau 2018; to select highest beta for GO enrichment

meanExprThresh_limma <- 0.5

# filter to keep only the highly variable genes
# Campbell 2018: 
# for BRAC, whose variance in log(TPM+1) expression was greater than 1 and whose median absolute deviation was greater than 0
# for COAD: s whose median absolute deviation in log(TPM+1) expression was greater than sqrt(0.5)
mad_thresh <- sqrt(0.5)

purityFilter <- 0.6  # for the input file

startTime <-  Sys.time()

source("phenopath_my_utils.R")


runPheno <- F
runNorm <- F
#recount
# https://f1000research.com/articles/6-1558/v1
# why not using gene symbols: https://www.biostars.org/p/352492/#352535

# see workflow from
# https://github.com/ELELAB/LUAD_LUSC_TCGA_comparison/blob/master/6-recount/unifiedLUAD_Rail_18062018.R
# then
# https://github.com/ELELAB/LUAD_LUSC_TCGA_comparison/blob/master/6-recount/LUAD/DE_unified_LUAD.R
# from this article https://bmccancer.biomedcentral.com/track/pdf/10.1186/s12885-019-5965-x.pdf


# I load the data retrieved from recount2 scripts
# so far:
# purity filter
# scale() from 

# TODO: 
# - gc_content normalization (TCGAbiolinks)
# - filter lowly expressed genes

plotType <- "png"
myHeight <- myWidth <- 400
myHeightGG <- 6
myWidthGG <- 6


inFolder <- file.path("..","tcga_data","DOWNLOAD_TCGA_GTEX_RECOUNT2")

# setwd("~/Documents/FREITAS_LAB/ovarian_project/phenopath")

outFolder <- "PHENOPATH_RECOUNT2_TCGA_OV"
dir.create(outFolder, recursive=TRUE)

# setwd("~/Documents/FREITAS_LAB/ovarian_project/phenopath")

# load input data
ov_data_raw <- get(load(file.path(inFolder, paste0("all_counts_onlyPF_", purityFilter, ".Rdata"))))
dim(ov_data_raw)
# 25226x533
stopifnot(ov_data_raw >= 0)


gtex_annot_dt <- get(load(file.path(inFolder, "gtex_sampleAnnot.RData")))
tcga_annot_dt <- get(load(file.path(inFolder, "tcga_sampleAnnot.Rdata")))




httr::set_config(httr::config(ssl_verifypeer = FALSE))  ### added to access ensembl biomart connection


#~~~~~ REACTOME ENRICHMENT analysis

ov_data_filtered <- get(load(file.path(outFolder, "ov_data_filtered.Rdata")))
ov_data_filteredT <- t(ov_data_filtered)
ov_phenopath_fit <- get(load(file.path(outFolder, "ov_phenopath_fit.Rdata")))
ov_pseudotimes <-  trajectory(ov_phenopath_fit)

gene_names <- colnames(ov_data_filteredT)
df_beta <- data.frame(beta = interaction_effects(ov_phenopath_fit),
                      beta_sd = interaction_sds(ov_phenopath_fit),
                      is_sig = significant_interactions(ov_phenopath_fit),
                      gene = gene_names)


###### FIRST WAY TO GET MATCHING IDS
mart <- useDataset("hsapiens_gene_ensembl", useMart("ensembl"))
listOfGenes_entrez <- getBM(attributes = c("entrezgene_id", "ensembl_gene_id", "gene_biotype"),
                            filters = c("biotype"),values = list(biotype="protein_coding"), mart = mart)
dim(listOfGenes_entrez)
# [1] 23069     3
stopifnot(df_beta$gene %in% listOfGenes_entrez$ensembl_gene_id)
listOfGenes_entrez <- listOfGenes_entrez[listOfGenes_entrez$ensembl_gene_id %in% df_beta$gene,]
dim(listOfGenes_entrez)
# [1] 6005    3
listOfGenes_entrez <- listOfGenes_entrez[!is.na(listOfGenes_entrez$entrezgene_id),]
dim(listOfGenes_entrez)
# 5982 3
# I need to have unique ensemblID
listOfGenes_entrez <- listOfGenes_entrez[!duplicated(listOfGenes_entrez$ensembl_gene_id),]
dim(listOfGenes_entrez)
# [1] 5982 3
any(duplicated(listOfGenes_entrez$entrezgene_id))
# TRUE
stopifnot(!duplicated(listOfGenes_entrez$ensembl_gene_id))
stopifnot(!is.na(listOfGenes_entrez$ensembl_gene_id))
listOfGenes_entrez1 <- setNames(listOfGenes_entrez$entrezgene_id, listOfGenes_entrez$ensembl_gene_id)
stopifnot(!is.na(listOfGenes_entrez1))

###### 2ND WAY TO GET MATCHING IDS
#columns(org.Hs.eg.db) # returns list of available keytypes
listOfGenes_entrez2 <- mapIds(org.Hs.eg.db,
                              keys=df_beta$gene, #Column containing Ensembl gene ids
                              column="ENTREZID",
                              keytype="ENSEMBL",
                              multiVals="first")
listOfGenes_entrez2 <- listOfGenes_entrez2[!is.na(listOfGenes_entrez2)]
stopifnot(!is.na(listOfGenes_entrez2))
length(listOfGenes_entrez2)
# 5996
any(duplicated(listOfGenes_entrez2))
# TRUE # also duplicated entrez

stopifnot(names(listOfGenes_entrez1) %in% df_beta$gene)
stopifnot(names(listOfGenes_entrez2) %in% df_beta$gene)
stopifnot(!is.na(listOfGenes_entrez2))
stopifnot(!is.na(listOfGenes_entrez1))

# if one is longer, take the longest, otherwise take the one with least duplicated entrezIDs (less ambiguous)
if(length(listOfGenes_entrez1) != length(listOfGenes_entrez2)) {
  if(length(listOfGenes_entrez1) > length(listOfGenes_entrez2)) {
    ens2entrez <- listOfGenes_entrez1
    cat(paste0("... take list 1\n"))
  } else {
    ens2entrez <- listOfGenes_entrez2
    cat(paste0("... take list 2\n"))
  }
} else {
  if(length(unique(listOfGenes_entrez1)) > length(unique(listOfGenes_entrez2))) {
    ens2entrez <- listOfGenes_entrez1
    cat(paste0("... take list 1\n"))
  } else { # if == take list 2 (do not know better way)
    ens2entrez <- listOfGenes_entrez2
    cat(paste0("... take list 2\n"))
  }
}
cat(paste0("av. genes with matched entrez ID:", length(ens2entrez), "/", nrow(df_beta), "\n"))
cat(paste0("# duplicated entrezIDs: ", sum(duplicated(ens2entrez)), "\n"))

df_beta_entrez <- df_beta[df_beta$gene %in% names(ens2entrez),]
stopifnot(paste0(df_beta_entrez$gene) %in% names(ens2entrez))
df_beta_entrez$gene_entrez <- ens2entrez[paste0(df_beta_entrez$gene)]
stopifnot(!is.na(df_beta_entrez))

top20_posbeta <- df_beta_entrez[order(df_beta_entrez$beta, decreasing = TRUE),][1:20,"gene_entrez"]

top20_negbeta <- df_beta_entrez[order(df_beta_entrez$beta, decreasing = FALSE),][1:20,"gene_entrez"]

top20_absbeta <- df_beta_entrez[order(abs(df_beta_entrez$beta), decreasing = TRUE),][1:20,"gene_entrez"]

# will not use the cutoff because no one signif, but still want to look at the top ones
# reactome_pvaluecutoff <- 0.05
# from here: https://www.biostars.org/p/434669/
# seems ok to leave universe param out
cat(paste0("... run Reactome PA\n"))
top_pos_React <- enrichPathway(gene=top20_posbeta, pvalueCutoff = 1 , readable=TRUE)
top_neg_React <- enrichPathway(gene=top20_negbeta, pvalueCutoff = 1 , readable=TRUE)
top_abs_React <- enrichPathway(gene=top20_absbeta, pvalueCutoff = 1 , readable=TRUE)
cat(paste0("...... finished\n"))

keep_cols <- c("Description", "GeneRatio", "BgRatio", "pvalue", "p.adjust", "qvalue", "geneID")
out_topPos <- top_pos_React@result[,keep_cols]
out_topPos$pvalue <- round(out_topPos$pvalue, 4)
out_topPos$p.adjust <- round(out_topPos$p.adjust, 4)
out_topPos$qvalue <- round(out_topPos$qvalue, 4)

outFile <- file.path(outFolder, "reactomeEnrichment_topPosBeta.txt")
write.table(out_topPos, file = outFile, sep="\t", col.names=T, row.names=F, quote=F)
cat(paste0("... written: ", outFile, "\n"))

out_topNeg <- top_neg_React@result[,keep_cols]
out_topNeg$pvalue <- round(out_topNeg$pvalue, 4)
out_topNeg$p.adjust <- round(out_topNeg$p.adjust, 4)
out_topNeg$qvalue <- round(out_topNeg$qvalue, 4)

outFile <- file.path(outFolder, "reactomeEnrichment_topNegBeta.txt")
write.table(out_topNeg, file = outFile, sep="\t", col.names=T, row.names=F, quote=F)
cat(paste0("... written: ", outFile, "\n"))


out_topAbs <- top_abs_React@result[,keep_cols]
out_topAbs$pvalue <- round(out_topAbs$pvalue, 4)
out_topAbs$p.adjust <- round(out_topAbs$p.adjust, 4)
out_topAbs$qvalue <- round(out_topAbs$qvalue, 4)
outFile <- file.path(outFolder, "reactomeEnrichment_topAbsBeta.txt")
write.table(out_topAbs, file = outFile, sep="\t", col.names=T, row.names=F, quote=F)
cat(paste0("... written: ", outFile, "\n"))


stop("--ok\n")












































# 1- gc content normalization
# xx=rownames(ov_data_raw)
# xx=xx[!grepl("_PAR_Y$", xx)]
# stopifnot(!duplicated(gsub("\\..*", "",xx)))
## I have some weird ENSGxx_PAR_Y genes -> remove them

## check the weird PAR_Y genes
tocheckgenes <- rownames(ov_data_raw)[grepl("_PAR_Y$", rownames(ov_data_raw))]
mygene=tocheckgenes[1]
for(mygene in tocheckgenes) {
  othergene <- gsub("_PAR_Y", "", mygene)
  if(!othergene %in% rownames(ov_data_raw)) next
  tmp_dt <- data.frame(ov_data_raw[mygene,],
                       ov_data_raw[othergene,])
  colnames(tmp_dt) <- c(mygene, othergene)
  tmp_dt <- log2(tmp_dt+1)
  outFile <- file.path(outFolder, paste0("check_dupgenes_", mygene, "_", othergene, ".", plotType))
  do.call(plotType, list(outFile, height=myHeight, width=myWidth))
  boxplot(tmp_dt)
  dev.off()
  cat(paste0("written ... ", outFile, "\n"))  
}

httr::set_config(httr::config(ssl_verifypeer = FALSE))  ### added to access ensembl biomart connection
tokeep <- ! grepl("_PAR_Y$", rownames(ov_data_raw))
cat(paste0("... remove weird genes: ", sum(!tokeep), "/", length(tokeep), "\n"))
ov_data_raw <- ov_data_raw[tokeep,]
stopifnot(!duplicated(gsub("\\..*", "",rownames(ov_data_raw))))
rownames(ov_data_raw)<-gsub("\\..*", "",rownames(ov_data_raw))
              # get list of all protein-coding genes
              mart <- useDataset("hsapiens_gene_ensembl", useMart("ensembl"))
              listOfGenes <- getBM(attributes = c("ensembl_gene_id","hgnc_symbol", "gene_biotype"),
                                   filters = c("biotype"),values = list(biotype="protein_coding"), mart = mart)
              head(listOfGenes)
              dim(listOfGenes)

              ov_data_forNorm <- subset(ov_data_raw,rownames(ov_data_raw) %in% listOfGenes$ensembl_gene_id)
              dim(ov_data_forNorm)
# [1] 19177   533

### normalize as in Lucchetta et al. 2019
if(runNorm) {
  ov_dat_gcNorm <- TCGAanalyze_Normalization(tabDF = ov_data_forNorm,
                                             geneInfo = geneInfoHT,
                                             method = "gcContent")
  outFile <- file.path(outFolder, "ov_data_gcNorm.Rdata")
  save(ov_dat_gcNorm, file=outFile)
  cat(paste0("... written: ", outFile, "\n"))
} else {
  outFile <- file.path(outFolder, "ov_data_gcNorm.Rdata")
  ov_dat_gcNorm <- get(load(outFile))
}

ov_data_gcNorm_log <- log2(ov_dat_gcNorm + 1)

nGTEX <- sum(grepl("^GTEX", colnames(ov_data_gcNorm_log)))
nTCGA <- sum(grepl("^TCGA", colnames(ov_data_gcNorm_log)))

################################### 
################################### PCA ON not norm DATA -> for comparison
################################### 
ov_data_notNorm_log <- log2(ov_data_forNorm + 1)

ov_data_notNorm_log_no0 <- ov_data_notNorm_log[rowSums(ov_data_notNorm_log) > 0,]


pca_ov <- prcomp(t(ov_data_notNorm_log_no0), scale=TRUE)
pca_ov_lowrepr <- pca_ov$x
stopifnot(nrow(pca_ov_lowrepr) == nGTEX+nTCGA)

outFile <- file.path(outFolder, paste0("in_raw_data_pca_12_tcga_gtex.", plotType))
do.call(plotType, list(outFile, height=myHeight, width=myWidth))
#dev.off()

pcaplot(pca_dt=pca_ov_lowrepr, pctoplot=c(1,2), summ_dt=summary(pca_ov),
        main="TCGA+GTEX OV notNorm (log2(.+1))",
        col=1+as.numeric(grepl("TCGA", rownames(pca_ov_lowrepr))))
mtext(text=paste0("nGTEX=",nGTEX, "; nTCGA=",nTCGA), side=3)
legend("topleft", legend=c("GTEX", "TCGA"), pch=16, col=c(1,2), bty="n")
dev.off()
cat(paste0("... written: ", outFile, "\n"))

outFile <- file.path(outFolder, paste0("in_raw_data_pca_23_tcga_gtex.", plotType))
do.call(plotType, list(outFile, height=myHeight, width=myWidth))
#dev.off()
pcaplot(pca_dt=pca_ov_lowrepr, pctoplot=c(2,3), summ_dt=summary(pca_ov),
        main="TCGA+GTEX OV notNorm (log2(.+1))",
        col=1+as.numeric(grepl("TCGA", rownames(pca_ov_lowrepr))))
mtext(text=paste0("nGTEX=",nGTEX, "; nTCGA=",nTCGA), side=3)
legend("topleft", legend=c("GTEX", "TCGA"), pch=16, col=c(1,2), bty="n")
dev.off()
cat(paste0("... written: ", outFile, "\n"))


#### check if I have some outliers within TCGA or GTEX cohorts
gtex_raw_data_log <- ov_data_notNorm_log[,grep("^GTEX", colnames(ov_data_notNorm_log))]
tcga_raw_data_log <- ov_data_notNorm_log[,grep("^TCGA", colnames(ov_data_notNorm_log))]
stopifnot(ncol(gtex_raw_data_log) + ncol(tcga_raw_data_log) == ncol(ov_data_notNorm_log))

### FOR PCA -> I need to remove genes that sum to 0 otherwise cannot scale data
gtex_raw_data_log <- gtex_raw_data_log[rowSums(gtex_raw_data_log) > 0,]
tcga_raw_data_log <- tcga_raw_data_log[rowSums(tcga_raw_data_log) > 0,]


# do I have batch effect within TCGA (plate)
# The default is FALSE for consistency with S, but in general scaling is advisable
# also scaled in https://kieranrcampbell.github.io/phenopath/phenopath_shalek_vignette.html
tcga_pca_ov <- prcomp(t(tcga_raw_data_log), scale=TRUE)
tcga_pca_ov_lowrepr <- tcga_pca_ov$x
stopifnot(nrow(tcga_pca_ov_lowrepr) == nTCGA)

stopifnot(tcga_annot_dt$cgc_sample_id == colnames(tcga_raw_data_log))
tcga_annot_dt$cgc_sample_tissue_source_site_fact <- as.factor(tcga_annot_dt$cgc_sample_tissue_source_site)


#dev.off()
outFile <- file.path(outFolder, paste0("in_raw_data_tcga_pca_12.", plotType))
do.call(plotType, list(outFile, height=myHeight, width=myWidth))
pcaplot(pca_dt=tcga_pca_ov_lowrepr, pctoplot=c(1,2), summ_dt=summary(tcga_pca_ov),
        col = tcga_annot_dt$cgc_sample_tissue_source_site_fact,
        main="TCGA OV notNorm (log2(.+1))")
mtext(text=paste0("nTCGA=",nTCGA, " (color-coded by tissue source site)"), side=3)
legend("topleft", legend=c("color-code source site"), bty="n")
# apparently there is no batch effect
dev.off()
cat(paste0("... written: ", outFile, "\n"))

#dev.off()
outFile <- file.path(outFolder, paste0("in_raw_data_tcga_pca_23.", plotType))
do.call(plotType, list(outFile, height=myHeight, width=myWidth))
pcaplot(pca_dt=tcga_pca_ov_lowrepr, pctoplot=c(2,3), summ_dt=summary(tcga_pca_ov),
        col = tcga_annot_dt$cgc_sample_tissue_source_site_fact,
        main="TCGA OV notNorm (log2(.+1))")
mtext(text=paste0("nTCGA=",nTCGA, " (color-coded by tissue source site)"), side=3)
legend("topleft", legend=c("color-code source site"), bty="n")
# apparently there is no batch effect
dev.off()
cat(paste0("... written: ", outFile, "\n"))


# do I have batch effect within gtex
gtex_pca_ov <- prcomp(t(gtex_raw_data_log), scale=TRUE)
gtex_pca_ov_lowrepr <- gtex_pca_ov$x
stopifnot(nrow(gtex_pca_ov_lowrepr) == nGTEX)


#dev.off()
outFile <- file.path(outFolder, paste0("in_raw_data_gtex_pca_12.", plotType))
do.call(plotType, list(outFile, height=myHeight, width=myWidth))
pcaplot(pca_dt=gtex_pca_ov_lowrepr, pctoplot=c(1,2), summ_dt=summary(gtex_pca_ov),
        main="GTEX OV notNorm (log2(.+1))")
mtext(text=paste0("nGTEX=",nGTEX, ""), side=3)
#legend("topleft", legend=c("color-code source site"), bty="n")
# here there is an issue with one guy !!!
dev.off()
cat(paste0("... written: ", outFile, "\n"))

#dev.off()
outFile <- file.path(outFolder, paste0("in_raw_data_gtex_pca_23.", plotType))
do.call(plotType, list(outFile, height=myHeight, width=myWidth))
pcaplot(pca_dt=gtex_pca_ov_lowrepr, pctoplot=c(2,3), summ_dt=summary(gtex_pca_ov),
        main="GTEX OV notNorm (log2(.+1))")
mtext(text=paste0("nGTEX=",nGTEX, ""), side=3)
#legend("topleft", legend=c("color-code source site"), bty="n")
# here there is an issue with one guy !!!
dev.off()
cat(paste0("... written: ", outFile, "\n"))

rm(gtex_raw_data_log)
rm(tcga_raw_data_log)

################################### 
################################### PCA ON NORM DATA 
################################### 

#### check if I have some outliers within TCGA or GTEX cohorts
gtex_data_log <- ov_data_gcNorm_log[,grep("^GTEX", colnames(ov_data_gcNorm_log))]
tcga_data_log <- ov_data_gcNorm_log[,grep("^TCGA", colnames(ov_data_gcNorm_log))]

stopifnot(ncol(gtex_data_log) + ncol(tcga_data_log) == ncol(ov_data_gcNorm_log))

### FOR PCA -> I need to remove genes that sum to 0 otherwise cannot scale data
tcga_data_log <- tcga_data_log[rowSums(tcga_data_log) > 0,]
gtex_data_log <- gtex_data_log[rowSums(gtex_data_log) > 0,]

# do I have batch effect within TCGA (plate)
# The default is FALSE for consistency with S, but in general scaling is advisable
# also scaled in https://kieranrcampbell.github.io/phenopath/phenopath_shalek_vignette.html
tcga_pca_ov <- prcomp(t(tcga_data_log), scale=TRUE)
tcga_pca_ov_lowrepr <- tcga_pca_ov$x
stopifnot(nrow(tcga_pca_ov_lowrepr) == nTCGA)

stopifnot(tcga_annot_dt$cgc_sample_id == colnames(tcga_data_log))
tcga_annot_dt$cgc_sample_tissue_source_site_fact <- as.factor(tcga_annot_dt$cgc_sample_tissue_source_site)

#dev.off()
outFile <- file.path(outFolder, paste0("in_data_tcga_pca_12.", plotType))
do.call(plotType, list(outFile, height=myHeight, width=myWidth))
pcaplot(pca_dt=tcga_pca_ov_lowrepr, pctoplot=c(1,2), summ_dt=summary(tcga_pca_ov),
        col = tcga_annot_dt$cgc_sample_tissue_source_site_fact,
        main="TCGA OV (log2(.+1))")
mtext(text=paste0("nTCGA=",nTCGA, " (color-coded by tissue source site)"), side=3)
legend("topleft", legend=c("color-code source site"), bty="n")
# apparently there is no batch effect
dev.off()
cat(paste0("... written: ", outFile, "\n"))

#dev.off()
outFile <- file.path(outFolder, paste0("in_data_tcga_pca_23.", plotType))
do.call(plotType, list(outFile, height=myHeight, width=myWidth))
pcaplot(pca_dt=tcga_pca_ov_lowrepr, pctoplot=c(2,3), summ_dt=summary(tcga_pca_ov),
        col = tcga_annot_dt$cgc_sample_tissue_source_site_fact,
        main="TCGA OV (log2(.+1))")
mtext(text=paste0("nTCGA=",nTCGA, " (color-coded by tissue source site)"), side=3)
legend("topleft", legend=c("color-code source site"), bty="n")
# apparently there is no batch effect
dev.off()
cat(paste0("... written: ", outFile, "\n"))


# do I have batch effect within gtex
gtex_pca_ov <- prcomp(t(gtex_data_log), scale=TRUE)
gtex_pca_ov_lowrepr <- gtex_pca_ov$x
stopifnot(nrow(gtex_pca_ov_lowrepr) == nGTEX)


#dev.off()
outFile <- file.path(outFolder, paste0("in_data_gtex_pca_12.", plotType))
do.call(plotType, list(outFile, height=myHeight, width=myWidth))
pcaplot(pca_dt=gtex_pca_ov_lowrepr, pctoplot=c(1,2), summ_dt=summary(gtex_pca_ov),
     main="GTEX OV (log2(.+1))")
mtext(text=paste0("nGTEX=",nGTEX, ""), side=3)
#legend("topleft", legend=c("color-code source site"), bty="n")
# here there is an issue with one guy !!!
dev.off()
cat(paste0("... written: ", outFile, "\n"))


#dev.off()
outFile <- file.path(outFolder, paste0("in_data_gtex_pca_23.", plotType))
do.call(plotType, list(outFile, height=myHeight, width=myWidth))
pcaplot(pca_dt=gtex_pca_ov_lowrepr, pctoplot=c(2,3), summ_dt=summary(gtex_pca_ov),
      main="GTEX OV (log2(.+1))")
mtext(text=paste0("nGTEX=",nGTEX, ""), side=3)
#legend("topleft", legend=c("color-code source site"), bty="n")
# apparently there is no batch effect
dev.off()
cat(paste0("... written: ", outFile, "\n"))
# stop("--ok\n")

# ################################## remove outlier in GTEX  no dont know why I saw it the first time...
# # outlier on PC2 !!!

                    # pc2_outlier <- names(which.max(abs(gtex_pca_ov_lowrepr[,2])))
                    # stopifnot(length(pc2_outlier) == 1)
                    # gtex_annot_dt[gtex_annot_dt$sampid == pc2_outlier,]
                    # 
                    # # remove it from everywhere
                    # ov_data_gcNorm_log <- ov_data_gcNorm_log[,colnames(ov_data_gcNorm_log) != pc2_outlier]
                    # stopifnot(ncol(ov_data_gcNorm_log) == nGTEX + nTCGA -1)
                    # nGTEX <- nGTEX -1 
                    # gtex_data_log <- ov_data_gcNorm_log[,grep("^GTEX", colnames(ov_data_gcNorm_log))]
                    # stopifnot(ncol(gtex_data_log) == nGTEX)
                    # gtex_annot_dt <- gtex_annot_dt[gtex_annot_dt$sampid != pc2_outlier,]
                    # stopifnot(gtex_annot_dt$sampid == colnames(gtex_data_log))
                    # 
                    # gtex_data_log <- gtex_data_log[rowSums(gtex_data_log) > 0,]
                    # 
                    # ########################### REDO THE GTEX PCA WITHOUT THE OUTLIER
                    # # do I have batch effect within gtex
                    # gtex_pca_ov <- prcomp(t(gtex_data_log), scale=TRUE)
                    # gtex_pca_ov_lowrepr <- gtex_pca_ov$x
                    # stopifnot(nrow(gtex_pca_ov_lowrepr) == nGTEX)
                    # 
                    # #dev.off()
                    # outFile <- file.path(outFolder, paste0("in_data_gtex_pca_12_no_outlier.", plotType))
                    # do.call(plotType, list(outFile, height=myHeight, width=myWidth))
                    # pcaplot(pca_dt=gtex_pca_ov_lowrepr, pctoplot=c(1,2), summ_dt=summary(gtex_pca_ov),
                    #         main="GTEX OV (log2(.+1))")
                    # mtext(text=paste0("nGTEX=",nGTEX, ""), side=3)
                    # #legend("topleft", legend=c("color-code source site"), bty="n")
                    # # here there is an issue with one guy !!!
                    # dev.off()
                    # cat(paste0("... written: ", outFile, "\n"))
                    # 
                    # #dev.off()
                    # outFile <- file.path(outFolder, paste0("in_data_gtex_pca_23_no_outlier.", plotType))
                    # do.call(plotType, list(outFile, height=myHeight, width=myWidth))
                    # pcaplot(pca_dt=gtex_pca_ov_lowrepr, pctoplot=c(2,3), summ_dt=summary(gtex_pca_ov),
                    #         main="GTEX OV (log2(.+1))")
                    # mtext(text=paste0("nGTEX=",nGTEX, ""), side=3)
                    # #legend("topleft", legend=c("color-code source site"), bty="n")
                    # # apparently there is no batch effect
                    # dev.off()
                    # cat(paste0("... written: ", outFile, "\n"))

rm(gtex_data_log)
rm(tcga_data_log)

# stop("--ok\n")

########################### KEEP ONLY VARIABLE GENES
# median absolute deviation in log(TPM+1)
# filter to keep only the highly variable genes
### this should be done after having checked for outliers...
nGenes <- nrow(ov_data_gcNorm_log)
all_mad <- apply(ov_data_gcNorm_log, 1, mad)
to_keep <- all_mad > mad_thresh
stopifnot(length(to_keep) == nGenes)
cat(paste0(sum(to_keep), "/", length(to_keep), "\n"))

plot(density(all_mad), main="all gene MADs (GTEX+TCGA)")
abline(v = mad_thresh, col="red")
legend("topright",legend=c(
  paste0("threshold = ", round(mad_thresh, 2)),
  paste0("to keep: ", sum(to_keep), "/", length(to_keep), "\n")), bty="n")

stopifnot(length(to_keep) == nrow(ov_data_gcNorm_log))
stopifnot(nGenes == nrow(ov_data_gcNorm_log))

ov_data_filtered <- ov_data_gcNorm_log[to_keep,]
stopifnot(nrow(ov_data_filtered) == sum(to_keep))
nGenes <- sum(to_keep)

outFile <- file.path(outFolder, paste0("ov_data_filtered.Rdata"))
save(ov_data_filtered, file=outFile)
cat(paste0("... written: ", outFile, "\n"))


### look how different are the TCGA and the GTEX data
##### distribution of the counts - before MAD filter
gtex_density_all <- density(ov_data_gcNorm_log[,grep("^GTEX", colnames(ov_data_gcNorm_log))])
tcga_density_all <- density(ov_data_gcNorm_log[,grep("^TCGA", colnames(ov_data_gcNorm_log))])

# dev.off()
outFile <- file.path(outFolder, paste0("all_counts_log_tcga_gtex_density.", plotType))
do.call(plotType, list(outFile, height=myHeight, width=myWidth))
plot(gtex_density_all, main="data density (log2(.+1))",
     xlim=range(c(gtex_density_all$x, tcga_density_all$x)),
     ylim=range(c(gtex_density_all$y, tcga_density_all$y)))
mtext(side=3, text="(all)")
lines(tcga_density_all, col="red")
legend("topright", legend=c("GTEX", "TCGA"),
       bty="n",
       col=c("black", "red"), lty=c(1,1))
dev.off()
cat(paste0("... written: ", outFile, "\n"))

##### distribution of the counts - after MAD filter
gtex_density_madF <- density(ov_data_filtered[,grep("^GTEX", colnames(ov_data_filtered))])
tcga_density_madF <- density(ov_data_filtered[,grep("^TCGA", colnames(ov_data_filtered))])

# dev.off()
outFile <- file.path(outFolder, paste0("MADfiltered_counts_log_tcga_gtex_density.", plotType))
do.call(plotType, list(outFile, height=myHeight, width=myWidth))
plot(gtex_density_madF, main="data density (log2(.+1))",
     xlim=range(c(gtex_density_madF$x, tcga_density_madF$x)),
     ylim=range(c(gtex_density_madF$y, tcga_density_madF$y)))
mtext(side=3, text="(MAD filtered)")
lines(tcga_density_madF, col="red")
legend("topright", legend=c("GTEX", "TCGA"),
       bty="n",
       col=c("black", "red"), lty=c(1,1))
dev.off()
cat(paste0("... written: ", outFile, "\n"))


##### distribution of the mads - before filtering
gtex_density_all <- density(apply(ov_data_gcNorm_log[,grep("^GTEX", colnames(ov_data_gcNorm_log))], 1, mad))
tcga_density_all <- density(apply(ov_data_gcNorm_log[,grep("^TCGA", colnames(ov_data_gcNorm_log))], 1, mad))

# dev.off()
outFile <- file.path(outFolder, paste0("all_mads_tcga_gtex_density.", plotType))
do.call(plotType, list(outFile, height=myHeight, width=myWidth))
plot(gtex_density_all, main="data density (log2(.+1))",
     xlim=range(c(gtex_density_all$x, tcga_density_all$x)),
     ylim=range(c(gtex_density_all$y, tcga_density_all$y)))
lines(tcga_density_all, col="red")
mtext(side=3, text="(all)")
legend("topright", legend=c("GTEX", "TCGA"),
       bty="n",
       col=c("black", "red"), lty=c(1,1))
dev.off()
cat(paste0("... written: ", outFile, "\n"))

# stop("OK\n")

##### distribution of the mads - after filtering
gtex_density_madF <- density(apply(ov_data_filtered[,grep("^GTEX", colnames(ov_data_filtered))], 1, mad))
tcga_density_madF <- density(apply(ov_data_filtered[,grep("^TCGA", colnames(ov_data_filtered))], 1, mad))

# dev.off()
outFile <- file.path(outFolder, paste0("MADfiltered_mads_tcga_gtex_density.", plotType))
do.call(plotType, list(outFile, height=myHeight, width=myWidth))
plot(gtex_density_madF, main="data density (log2(.+1))",
     xlim=range(c(gtex_density_madF$x, tcga_density_madF$x)),
     ylim=range(c(gtex_density_madF$y, tcga_density_madF$y)))
lines(tcga_density_madF, col="red")
mtext(side=3, text="(MAD filtered)")
legend("topright", legend=c("GTEX", "TCGA"),
       bty="n",
       col=c("black", "red"), lty=c(1,1))
dev.off()
cat(paste0("... written: ", outFile, "\n"))

##############################################################
############################################################## PCA on merged data
##############################################################
# ov_data_filtered <- get(load("PHENOPATH_RECOUNT2_TCGA_OV/ov_data_filtered.Rdata"))

# phenopath tuto: sim$y is the N×G matrix of gene expression (N=100 cells and G=40 genes)
# so I have to take the transpose of my ov_data_log_matrix to have samples in line and genes in columns
ov_data_filteredT <- t(ov_data_filtered)
stopifnot(nGenes == ncol(ov_data_filteredT))
stopifnot(nGTEX+nTCGA == nrow(ov_data_filteredT))

pca_ov <- prcomp(ov_data_filteredT, scale=TRUE)
pca_ov_lowrepr <- pca_ov$x
stopifnot(nrow(pca_ov_lowrepr) == nGTEX+nTCGA)

pc1 <- pca_ov_lowrepr[,1]
pc2 <- pca_ov_lowrepr[,2]
pc3 <- pca_ov_lowrepr[,3]

outFile <- file.path(outFolder, paste0("in_data_pca_12_tcga_gtex.", plotType))
do.call(plotType, list(outFile, height=myHeight, width=myWidth))
#dev.off()

pcaplot(pca_dt=pca_ov_lowrepr, pctoplot=c(1,2), summ_dt=summary(pca_ov),
        main="TCGA+GTEX OV (log2(.+1))",
        col=1+as.numeric(grepl("TCGA", rownames(pca_ov_lowrepr))))
mtext(text=paste0("nGTEX=",nGTEX, "; nTCGA=",nTCGA), side=3)
legend("topleft", legend=c("GTEX", "TCGA"), pch=16, col=c(1,2), bty="n")
dev.off()
cat(paste0("... written: ", outFile, "\n"))

outFile <- file.path(outFolder, paste0("in_data_pca_23_tcga_gtex.", plotType))
do.call(plotType, list(outFile, height=myHeight, width=myWidth))
#dev.off()
pcaplot(pca_dt=pca_ov_lowrepr, pctoplot=c(2,3), summ_dt=summary(pca_ov),
        main="TCGA+GTEX OV (log2(.+1))",
        col=1+as.numeric(grepl("TCGA", rownames(pca_ov_lowrepr))))
mtext(text=paste0("nGTEX=",nGTEX, "; nTCGA=",nTCGA), side=3)
legend("topleft", legend=c("GTEX", "TCGA"), pch=16, col=c(1,2), bty="n")
dev.off()
cat(paste0("... written: ", outFile, "\n"))

##############################################################
############################################################## LET'S DO PHENO
##############################################################

### how to set the covar ?? explained here: https://kieranrcampbell.github.io/phenopath/phenopath_shalek_vignette.html
# # 4.2 Inference with PhenoPath
# First we must decide how to pass in the covariate information (ie the stimulant applied) to the software as the x
# values. Here we will give cells exposed to LPS a value of 1 and cells exposed to PAM a value of -1.
# This means the overall pathway loading λ is the average change for LPS and PAM cells, 
# while if the β parameter is positive it means the gene is more upregulated over pseudotime under LPS and 
# if β is negative it means the gene is more upregulated under PAM11 
# Instead we could encode LPS to 1 and PAM to 0, in which case the pathway loading λ would be the change under PAM and λ+β
# the change under LPS stimulation..

# so here give a value of 1 in tumor and a value of -1 in normal
# This means the overall pathway loading λ is the average change for normal and tumor
# if β > 0 =>  the gene is more upregulated over pseudotime under tumor  
# if β  < 0 =>   the gene is more upregulated under normal 


# phenopath needs a cell-by-gene matrix = N×G matrix of gene expression (N=samples, G = genes)
stopifnot(nrow(ov_data_filteredT) == nGTEX+nTCGA)
stopifnot(ncol(ov_data_filteredT) == nGenes)
mycovar <- 2 * grepl("^TCGA", rownames(ov_data_filteredT)) - 1
stopifnot(sum(mycovar== -1) == nGTEX)
stopifnot(sum(mycovar== 1) == nTCGA)
stopifnot(!is.na(mycovar))

if(runPheno) {
  ov_phenopath_fit <- phenopath(ov_data_filteredT, mycovar, elbo_tol = 1e-6, thin = 40)
  
  outFile <- file.path(outFolder, paste0("ov_phenopath_fit.Rdata"))
  save(ov_phenopath_fit, file=outFile)
  cat(paste0("... written: ", outFile, "\n"))
  
} else {
  outFile <- file.path(outFolder, paste0("ov_phenopath_fit.Rdata"))
  ov_phenopath_fit <- get(load(outFile))
}
#   ov_phenopath_fit <- get(load("PHENOPATH_RECOUNT2_TCGA_OV/ov_phenopath_fit.Rdata"))


######################################################## 
##############  PHENOPATH RESULT ANLAYSIS
######################################################## 

####### check the model
# it is important to check convergence with a call to plot_elbo(ov_phenopath_fit) to ensure the ELBO is approximately flat:

outFile <- file.path(outFolder, paste0("phenopath_elbo_fit.", plotType))
p <- plot_elbo(ov_phenopath_fit)
ggsave(p, filename = outFile, height=myHeightGG, width=myWidthGG)
cat(paste0("... written: ", outFile, "\n"))

  
####### retrieve the pseudotimes
# maximum a-posteriori (MAP) estimates of the pseudotimes using the trajectory()

ov_pseudotimes <-  trajectory(ov_phenopath_fit)
 
############## correlation with PCs ##############
### look if the pseudotimes correlate with the PCs
# tumor=1, normal=-1

# dev.off()
outFile <- file.path(outFolder, paste0("corr_pseudotimes_pc1.", plotType))
do.call(plotType, list(outFile, height=myHeight, width=myWidth))
plot(x = pc1, 
     y = ov_pseudotimes,
     xlab = "PC1", ylab="PP Pseudotimes z",
     col = mycovar+3,
     pch=16, cex=0.7,
     cex.lab = 1.2, cex.axis=1.2)
add_corr(pc1, ov_pseudotimes)
foo <- dev.off()
cat(paste0("... written: ", outFile, "\n"))

outFile <- file.path(outFolder, paste0("corr_pseudotimes_pc2.", plotType))
do.call(plotType, list(outFile, height=myHeight, width=myWidth))
plot(x = pc2, 
     y = ov_pseudotimes,
     xlab = "PC2", ylab="PP Pseudotimes z",
     col = mycovar+3,
     pch=16, cex=0.7,
     cex.lab = 1.2, cex.axis=1.2)
add_corr(pc2, ov_pseudotimes)
foo <- dev.off()
cat(paste0("... written: ", outFile, "\n"))

outFile <- file.path(outFolder, paste0("corr_pseudotimes_pc3.", plotType))
do.call(plotType, list(outFile, height=myHeight, width=myWidth))
plot(x = pc3, 
     y = ov_pseudotimes,
     xlab = "PC3", ylab="PP Pseudotimes z",
     col = mycovar+3,
     pch=16, cex=0.7,
     cex.lab = 1.2, cex.axis=1.2)
add_corr(pc3, ov_pseudotimes)
foo <- dev.off()
cat(paste0("... written: ", outFile, "\n"))

############## LOOK A BIT AT THE BETA VALUES ##############
# density of the beta with color code signifcance

gene_names <- colnames(ov_data_filteredT)

df_beta <- data.frame(beta = interaction_effects(ov_phenopath_fit),
                      beta_sd = interaction_sds(ov_phenopath_fit),
                      is_sig = significant_interactions(ov_phenopath_fit),
                      gene = gene_names)

outFile <- file.path(outFolder, paste0("beta_values_distribution.", plotType))
do.call(plotType, list(outFile, height=myHeight, width=myWidth))
plot(density(df_beta$beta))
lines(density(df_beta$beta[df_beta$is_sig]), col=2)
# lines(density(df_beta$beta[!df_beta$is_sig]), col=3)
legend("topright", legend=c("all dist.", "only signif. dist."), lty=1, col=c(1,2), bty="n")
mtext(side=3, text=paste0("# signif: ", sum(df_beta$is_sig), "/", nrow(df_beta)))
foo <- dev.off()
cat(paste0("... written: ", outFile, "\n"))


############## top significant interactions pseudotime x covar ##############

# look at the top bottom and up interaction effects
nTop <- 10
  
# show the top genes with signif interactions
tmp_beta <- df_beta[order(df_beta$beta, decreasing = TRUE),]
topPosGenes <- tmp_beta[1:nTop,]
topPosGenes$dir <- "pos"
tmp_beta <- df_beta[order(df_beta$beta, decreasing = FALSE),]
topNegGenes <- tmp_beta[1:nTop,]
topNegGenes$dir <- "neg"

dfBeta_topGenes <- rbind(topPosGenes, topNegGenes)
stopifnot(!duplicated(dfBeta_topGenes$gene))
dfBeta_topGenes$gene <- as.character(dfBeta_topGenes$gene)

gene_lab_dt <- get(load(file.path(inFolder, "out_intersect_dt.RData")))
gene_lab_dt$geneID_short <-gsub("\\..*", "",gene_lab_dt$geneID)
gene_lab_dt <- unique(gene_lab_dt[,c("geneSymb", "geneID_short")])
stopifnot(!duplicated(gene_lab_dt$geneID_short))
ens2genes <- setNames(gene_lab_dt$geneSymb, gene_lab_dt$geneID_short)
stopifnot(dfBeta_topGenes$gene %in% gene_lab_dt$geneID_short)
stopifnot(dfBeta_topGenes$gene %in% names(ens2genes))
dfBeta_topGenes$geneSymb <- ens2genes[dfBeta_topGenes$gene]
stopifnot(!duplicated(dfBeta_topGenes$geneSymb))
dfBeta_topGenes$geneSymb <- factor(dfBeta_topGenes$geneSymb, levels=dfBeta_topGenes$geneSymb)
dfBeta_topGenes$dir <- factor(dfBeta_topGenes$dir, levels=c("pos", "neg"))
  
p <-  ggplot(dfBeta_topGenes, aes(x = geneSymb, y = beta, color = is_sig)) +
    geom_point() +
    facet_wrap(. ~ dir ,scales="free") +
    ggtitle(paste0("Genes with top ", betaU), subtitle=paste0("(", nTop, " lowest and highest)"))+
    geom_errorbar(aes(ymin = beta - 2 * beta_sd, ymax = beta + 2 * beta_sd)) +
    theme(plot.title = element_text(hjust=0.5),
          plot.subtitle = element_text(hjust=0.5),
          axis.text.x = element_text(angle = 90, hjust = 1),
          axis.title.x = element_blank()) +
    ylab(expression(beta)) +
    scale_color_brewer(palette = "Set2", name = "Significant")

outFile <- file.path(outFolder, paste0("genes_with_top_and_bottom_n", nTop, "_beta.", plotType))
ggsave(p, filename = outFile, height=myHeightGG, width=myWidthGG*1.2)
cat(paste0("... written: ", outFile, "\n"))


############## top significant interactions pseudotime x covar ##############
# which gene has highest interaction effect ?

stopifnot(df_beta$gene %in% names(ens2genes))
stopifnot(!duplicated(df_beta$gene))
# if duplicated I would need to do some manual curation...
df_beta$geneSymb <- ens2genes[df_beta$gene]

# the same for the lowest interaction effect ?

p <- plot_iGeneExpr(igene= which.max(df_beta$beta),
               exprdt=ov_data_filteredT,
               pseudot=ov_pseudotimes,
               covarlab=ifelse(mycovar == 1, "TCGA", "GTEX"),
               valuedt=df_beta,
               valuecol="beta", symbcol="geneSymb", subtit=paste0("highest ", betaU))

outFile <- file.path(outFolder, paste0("highestBetaGene_expr_along_pseudotime.", plotType))
ggsave(plot = p, filename = outFile, height=myHeightGG, width = myWidthGG*1.2)
cat(paste0("... written: ", outFile, "\n"))

p <- plot_iGeneExpr_gg2(igene= which.max(df_beta$beta),
                    exprdt=ov_data_filteredT,
                    pseudot=ov_pseudotimes,
                    covarlab=ifelse(mycovar == 1, "TCGA", "GTEX"),
                    valuedt=df_beta,
                    valuecol="beta", symbcol="geneSymb", subtit=paste0("highest ", betaU))

outFile <- file.path(outFolder, paste0("highestBetaGene_expr_along_pseudotime_gg2.", plotType))
ggsave(plot = p, filename = outFile, height=myHeightGG*0.9, width = myWidthGG*1.5)
cat(paste0("... written: ", outFile, "\n"))



p <- plot_iGeneExpr(igene= which.min(df_beta$beta),
               exprdt=ov_data_filteredT,
               pseudot=ov_pseudotimes,
               covarlab=ifelse(mycovar == 1, "TCGA", "GTEX"),
               valuedt=df_beta,
                           valuecol="beta", symbcol="geneSymb", subtit=paste0("lowest ", betaU))

outFile <- file.path(outFolder, paste0("lowestBetaGene_expr_along_pseudotime.", plotType))
ggsave(plot = p, filename = outFile, height=myHeightGG*0.9, width = myWidthGG*1.2)
cat(paste0("... written: ", outFile, "\n"))

p <- plot_iGeneExpr_gg2(igene= which.min(df_beta$beta),
                    exprdt=ov_data_filteredT,
                    pseudot=ov_pseudotimes,
                    covarlab=ifelse(mycovar == 1, "TCGA", "GTEX"),
                    valuedt=df_beta,
                    valuecol="beta", symbcol="geneSymb", subtit=paste0("lowest ", betaU))

outFile <- file.path(outFolder, paste0("lowestBetaGene_expr_along_pseudotime_gg2.", plotType))
ggsave(plot = p, filename = outFile, height=myHeightGG*0.9, width = myWidthGG*1.5)
cat(paste0("... written: ", outFile, "\n"))


#### do the same for the top 9 (3x3 grid) pos beta   convergence ???
## many of the 20 top beta value genes exhibit convergence
stopifnot(ov_phenopath_fit$m_beta[1,] == df_beta$beta)
stopifnot(ov_phenopath_fit$feature_names == df_beta$gene)

df_beta$alpha <- ov_phenopath_fit$m_alpha[1,]
df_beta$crossover <- -df_beta$alpha/df_beta$beta
stopifnot(!is.na(df_beta))


top_gs <- df_beta$gene[order(df_beta$beta, decreasing = TRUE)][1:9]

all_p <- list()

for(i in 1:length(top_gs)) {
  ens_gs <- top_gs[i]
  if(!ens_gs %in% names(ens2genes)) {
    cat(paste0("warning: ", ens_gs, " not available\n"))
    next
  }
  i_gs <- which(df_beta$gene == ens_gs)
  stopifnot(ens_gs == df_beta$gene[i_gs])
  cat(paste0(i), "\n")
  # cat(paste0(gs), "\n")
  cat(paste0(ens_gs), "\n")
  # cat(paste0(which(ens2genes==gs)), "\n")
  # cat(paste0(names(ens2genes)[ens2genes==gs]), "\n")
  cp_gs <- df_beta$crossover[i_gs]
  
  stopifnot(length(i_gs) == 1)
  tmp_dt <- df_beta
  tmp_dt <- tmp_dt[order(abs(tmp_dt$beta), decreasing = TRUE),]
  
  gs_beta_rank <- which(tmp_dt$gene == ens_gs)
  stopifnot(length(gs_beta_rank) == 1)
  gs_signif <- as.character(df_beta$is_sig[i_gs])
  gs_beta <- round(df_beta$beta[i_gs], 3)
  
  p <- plot_iGeneExpr_gg2(igene= i_gs,
                          exprdt=ov_data_filteredT,
                          pseudot=ov_pseudotimes,
                          covarlab=ifelse(mycovar == 1, "TCGA", "GTEX"),
                          valuedt=df_beta,
                          valuecol="beta", symbcol="geneSymb", 
                          subtit=paste0(betaU, " rank=", gs_beta_rank, "; signif=",gs_signif ))
  
  # add crossoverline
  p <- p + geom_vline(xintercept = cp_gs, linetype=2)
  all_p[[i]] <- p
}
ag_allp <- do.call(gridExtra:::grid.arrange,c(all_p, ncol=3))


outFile <- file.path(outFolder, paste0( "all_topPosBeta_geneExpr_along_pseudotime_withCP_gg2.", plotType))
ggsave(plot = ag_allp, filename = outFile, height=myHeightGG*2, width = myWidthGG*3)
cat(paste0("... written: ", outFile, "\n"))

#### do the same for the top 9 (3x3 grid) neg beta 
top_gs <- df_beta$gene[order(df_beta$beta, decreasing = FALSE)][1:9]

all_p <- list()

for(i in 1:length(top_gs)) {
  ens_gs <- top_gs[i]
  if(!ens_gs %in% names(ens2genes)) {
    cat(paste0("warning: ", ens_gs, " not available\n"))
    next
  }
  i_gs <- which(df_beta$gene == ens_gs)
  stopifnot(ens_gs == df_beta$gene[i_gs])
  cat(paste0(i), "\n")
  # cat(paste0(gs), "\n")
  cat(paste0(ens_gs), "\n")
  # cat(paste0(which(ens2genes==gs)), "\n")
  # cat(paste0(names(ens2genes)[ens2genes==gs]), "\n")
  cp_gs <- df_beta$crossover[i_gs]
  
  stopifnot(length(i_gs) == 1)
  tmp_dt <- df_beta
  tmp_dt <- tmp_dt[order(abs(tmp_dt$beta), decreasing = TRUE),]
  
  gs_beta_rank <- which(tmp_dt$gene == ens_gs)
  stopifnot(length(gs_beta_rank) == 1)
  gs_signif <- as.character(df_beta$is_sig[i_gs])
  gs_beta <- round(df_beta$beta[i_gs], 3)
  
  p <- plot_iGeneExpr_gg2(igene= i_gs,
                          exprdt=ov_data_filteredT,
                          pseudot=ov_pseudotimes,
                          covarlab=ifelse(mycovar == 1, "TCGA", "GTEX"),
                          valuedt=df_beta,
                          valuecol="beta", symbcol="geneSymb", 
                          subtit=paste0(betaU, " rank=", gs_beta_rank, "; signif=",gs_signif ))
  
  # add crossoverline
  p <- p + geom_vline(xintercept = cp_gs, linetype=2)
  all_p[[i]] <- p
}
ag_allp <- do.call(gridExtra:::grid.arrange,c(all_p, ncol=3))


outFile <- file.path(outFolder, paste0( "all_topNegBeta_geneExpr_along_pseudotime_withCP_gg2.", plotType))
ggsave(plot = ag_allp, filename = outFile, height=myHeightGG*2, width = myWidthGG*3)
cat(paste0("... written: ", outFile, "\n"))



############## look trajectory and phenotypes (tumor stages, age, etc.) ##############

table(tcga_annot_dt$cgc_case_days_to_death)
table(tcga_annot_dt$cgc_slide_percent_tumor_cells)


stopifnot(rownames(ov_data_filteredT) == c(gtex_annot_dt$sampid, tcga_annot_dt$cgc_sample_id))


all_traj <- setNames(ov_pseudotimes, rownames(ov_data_filteredT))
stopifnot(names(all_traj) == c(gtex_annot_dt$sampid, tcga_annot_dt$cgc_sample_id))

############### TCGA data
stopifnot(tcga_annot_dt$gdc_cases.samples.sample_type == tcga_annot_dt$cgc_sample_sample_type)

# > cgc_case_age_at_diagnosis
# Error: object 'cgc_case_age_at_diagnosis' not found
# > cgc_case_days_to_death
# Error: object 'cgc_case_days_to_death' not found
# > cgc_case_clinical_stage
# > cgc_durg_therapy_drug_name
# # Error: object 'cgc_durg_therapy_drug_name' not found -> too many
# > cgc_follow_up_days_to_deathg
# Error: object 'cgc_follow_up_days_to_deathg' not found
# > histologic name and gdc_cases.project .name grep serous
# Error: unexpected symbol in "histologic name"
# > sampletypeID


myplotlab <- "tumor stage"
stg_ords <-c(  "Stage IC", "Stage IIA" ,"Stage IIB" , "Stage IIC","Stage IIIA", "Stage IIIB","Stage IIIC",   "Stage IV")
p <- plot_pheno_catego(tcga_annot_dt,  pt_traj = all_traj, plotvar= "cgc_case_clinical_stage", plotxlab=paste0("TCGA HGSC ", myplotlab), varords=stg_ords)
outFile <- file.path(outFolder, paste0("boxplot_pseudotimes_by_", paste0(gsub(" ", "_",myplotlab)),"_TCGA.", plotType))
ggsave(plot = p, filename = outFile, height=myHeightGG, width = myWidthGG)
cat(paste0("... written: ", outFile, "\n"))


# plot_pheno_catego(tcga_annot_dt,  pt_traj = all_traj, plotvar= "cgc_drug_therapy_drug_name", plotlab="drug therapy", varords=NULL)
## too many categories


myplotlab <- "year of birth"
p <- plot_pheno_continuous(tcga_annot_dt,  pt_traj = all_traj, plotvar= "gdc_cases.demographic.year_of_birth", plotxlab=paste0("TCGA HGSC ", myplotlab))
outFile <- file.path(outFolder, paste0("boxplot_pseudotimes_by_", paste0(gsub(" ", "_",myplotlab)),"_TCGA.", plotType))
ggsave(plot = p, filename = outFile, height=myHeightGG, width = myWidthGG)
cat(paste0("... written: ", outFile, "\n"))

myplotlab <- "days to death"
p <- plot_pheno_continuous(tcga_annot_dt,  pt_traj = all_traj, plotvar= "cgc_case_days_to_death", plotxlab=paste0("TCGA HGSC ", myplotlab))
outFile <- file.path(outFolder, paste0("boxplot_pseudotimes_by_", paste0(gsub(" ", "_",myplotlab)),"_TCGA.", plotType))
ggsave(plot = p, filename = outFile, height=myHeightGG, width = myWidthGG)
cat(paste0("... written: ", outFile, "\n"))

myplotlab <- "diag. days to birth"
p <- plot_pheno_continuous(tcga_annot_dt,  pt_traj = all_traj, plotvar= "gdc_cases.diagnoses.days_to_birth", plotxlab=paste0("TCGA HGSC ", myplotlab))
outFile <- file.path(outFolder, paste0("boxplot_pseudotimes_by_", paste0(gsub(" ", "_",myplotlab)),"_TCGA.", plotType))
ggsave(plot = p, filename = outFile, height=myHeightGG, width = myWidthGG)
cat(paste0("... written: ", outFile, "\n"))


myplotlab <- "age at diag."
p <- plot_pheno_continuous(tcga_annot_dt,  pt_traj = all_traj, plotvar= "gdc_cases.diagnoses.age_at_diagnosis", plotxlab=paste0("TCGA HGSC ", myplotlab))
outFile <- file.path(outFolder, paste0("boxplot_pseudotimes_by_", paste0(gsub(" ", "_",myplotlab)),"_TCGA.", plotType))
ggsave(plot = p, filename = outFile, height=myHeightGG, width = myWidthGG)
cat(paste0("... written: ", outFile, "\n"))

myplotlab <- "slide pct normal cells"
p <- plot_pheno_continuous(tcga_annot_dt,  pt_traj = all_traj, plotvar= "cgc_slide_percent_normal_cells", plotxlab=paste0("TCGA HGSC ", myplotlab))
outFile <- file.path(outFolder, paste0("boxplot_pseudotimes_by_", paste0(gsub(" ", "_",myplotlab)),"_TCGA.", plotType))
ggsave(plot = p, filename = outFile, height=myHeightGG, width = myWidthGG)
cat(paste0("... written: ", outFile, "\n"))

myplotlab <- "slide pct neutrophil infilt."
p <- plot_pheno_continuous(tcga_annot_dt,  pt_traj = all_traj, plotvar= "cgc_slide_percent_neutrophil_infiltration", plotxlab=paste0("TCGA HGSC ", myplotlab))
outFile <- file.path(outFolder, paste0("boxplot_pseudotimes_by_", paste0(gsub(" ", "_",myplotlab)),"_TCGA.", plotType))
ggsave(plot = p, filename = outFile, height=myHeightGG, width = myWidthGG)
cat(paste0("... written: ", outFile, "\n"))

myplotlab <- "slide pct monocyte infilt."
p <- plot_pheno_continuous(tcga_annot_dt,  pt_traj = all_traj, plotvar= "cgc_slide_percent_monocyte_infiltration", plotxlab=paste0("TCGA HGSC ", myplotlab))
outFile <- file.path(outFolder, paste0("boxplot_pseudotimes_by_", paste0(gsub(" ", "_",myplotlab)),"_TCGA.", plotType))
ggsave(plot = p, filename = outFile, height=myHeightGG, width = myWidthGG)
cat(paste0("... written: ", outFile, "\n"))


myplotlab <- "slide pct lymphocyt infilt."
p <- plot_pheno_continuous(tcga_annot_dt,  pt_traj = all_traj, plotvar= "cgc_slide_percent_lymphocyte_infiltration", plotxlab=paste0("TCGA HGSC ", myplotlab))
outFile <- file.path(outFolder, paste0("boxplot_pseudotimes_by_", paste0(gsub(" ", "_",myplotlab)),"_TCGA.", plotType))
ggsave(plot = p, filename = outFile, height=myHeightGG, width = myWidthGG)
cat(paste0("... written: ", outFile, "\n"))







############### GTEX data

age_ords <- sort(unique(gtex_annot_dt$AGE))

gtex_traj_dt <- data.frame(
    gtex_samp = gtex_annot_dt$sampid,
  gtex_age = gtex_annot_dt$AGE,
  pseudotime = all_traj[gtex_annot_dt$sampid],
  stringsAsFactors = FALSE
)
sum(is.na(gtex_traj_dt$gtex_age))
# 3
gtex_traj_dt <- gtex_traj_dt[!is.na(gtex_traj_dt$gtex_age),]
stopifnot(!is.na(gtex_traj_dt))
gtex_traj_dt$gtex_age <- factor(gtex_traj_dt$gtex_age, levels=age_ords)
stopifnot(!is.na(gtex_traj_dt$gtex_age))


p <- ggplot(gtex_traj_dt, aes(x= gtex_age, y= pseudotime) )+
  geom_boxplot(notch = F, outlier.shape=NA)+
  geom_jitter(aes(col=gtex_age),alpha=0.7,position=position_jitterdodge())+
  ggtitle(paste0("Pseudotime by age class"), subtitle = paste0("(GTEX data)"))+
  scale_color_nejm()+
  ylab("PP Pseudotimes")+
  xlab("GTEX donnor age class")+
  myG_theme +
  labs(color="")+
  theme(axis.text.x=element_blank(),
        axis.ticks.x = element_blank() )

outFile <- file.path(outFolder, paste0("boxplot_pseudotimes_by_age_GTEX.", plotType))
ggsave(plot = p, filename = outFile, height=myHeightGG, width = myWidthGG)
cat(paste0("... written: ", outFile, "\n"))


############## further look at the signif. interactions ##############

# extract the interaction parameters 
# -  feature =>  The feature (usually gene)
# - covariate => The covariate, specified from the order originally supplied to the call to phenopath
# - interaction_effect_size => The effect size of the interaction (β
# - significant => Boolean for whether the interaction effect is significantly different from 0
# - chi => The precision of the ARD prior on β [Automatic Relevance Determination]
# - pathway_loading => The pathway loading λ

int_dt <- interactions(ov_phenopath_fit)
stopifnot(as.character(int_dt$feature) %in% names(ens2genes))
int_dt$featureSymb <- ens2genes[as.character(int_dt$feature) ]

# plot the posterior ARD variances (1/χ) against the posterior interaction effect sizes (β)
# colouring them by which are found to be significant and annotating the top few genes:

chi_cutoff <- sort(int_dt$chi)[11]


p <- ggplot(int_dt, aes(x = interaction_effect_size, y = 1 / chi,
                 color = significant_interaction)) +
  ggtitle("", subtitle=paste0("labs: ", chiU, " top10"))+
  xlab(paste0("posterior interaction effect sizes (", lambdaU, ")"))+
  ylab(paste0("posterior ARD variances (1/", chiU, ")"))+
  geom_point() +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10))+
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10))+
  geom_text_repel(data = dplyr::filter(int_dt, chi < chi_cutoff),
                  aes(label = featureSymb)) +
  labs(color="significant")+
  scale_colour_brewer(palette = "Set1")+
  theme(plot.subtitle = element_text(hjust=0.5),
        axis.text = element_text(size = 11),
        axis.title = element_text(size = 12),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 11))


outFile <- file.path(outFolder, paste0("posteriorARDchi_vs_posteriorEffectSizeBeta.", plotType))
ggsave(plot = p, filename = outFile, height=myHeightGG, width=myWidthGG*1.4)
cat(paste0("... written: ", outFile, "\n"))

# plot the “landscape” of interactions, where we plot the interaction effect size against the pathway score.
# The further up the y-axis a gene is, the more it is upregulated under tumor rather than normal (and vice-versa),
# while the further along the x-axis a gene is, the more it is upregulated over pseudotime regardless of the covariate condition

# y = covariate-pseudotime interaction (beta)
# x = gene regulation over pseudotime (pathway loading)
# x<0 & y>0 [left,top]: gene downreg. along pseudotime, cond=-1 increases downregulation
# x<0 & y<0 [left, bottom]: gene downreg. along pseudotime, cond=+1 increases downregulation
# x>0 & y>0 [right, top]: gene upreg. along pseudotime, cond=+1 increases upregulation
# x>0 & y<0 [right, bottom]: gene upreg. along pseudotime, cond=-1 increases upregulation

p <- ggplot(int_dt, aes(x = pathway_loading, y = interaction_effect_size,
                 color = significant_interaction)) +
  ggtitle("", subtitle=paste0("labs: ", chiU, " top10"))+
  geom_point() +
  ylab(paste0("posterior interaction effect sizes (", betaU, ")"))+
  xlab(paste0("pathway loading (", lambdaU, ")"))+
  geom_text_repel(data = dplyr::filter(int_dt, chi < chi_cutoff),
                  aes(label = featureSymb), size = 5) +
  scale_colour_brewer(palette = "Set1")  +
  labs(color="significant")+
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10))+
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10))+
  theme(plot.subtitle = element_text(hjust=0.5),
        axis.text = element_text(size = 11),
        axis.title = element_text(size = 12),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 11))

outFile <- file.path(outFolder, paste0("posteriorEffectSizeBeta_vs_pathwayloadingLambda.", plotType))
ggsave(plot = p, filename = outFile, height=myHeightGG, width=myWidthGG*1.4)
cat(paste0("... written: ", outFile, "\n"))


stop("--ok\n")



int_dt$is_sig_graph <- 
  plyr::mapvalues(int_dt$significant_interaction, from = c(FALSE, TRUE),
                  to = c("Non-significant", "Significant"))

textinfo <- frame_data(
  ~x, ~y, ~label,
  0.6, 0.15, "Gene upregulated\nTumor increases upregulation",
  0.6, -0.15, "Gene upregulated\nTumor decreases upregulation",
  -0.7, 0.15, "Gene downregulated\nTumor decreases downregulation",
  -0.7, -0.15, "Gene downregulated\nTumor increases downregulation"
)
cols <- RColorBrewer::brewer.pal(3, "Set2")
cols2 <- c("#c5e2d9", cols[2])
outline_cols = c("#c5e2d9", 'black')
p <- ggplot(int_dt, aes(x = pathway_loading, y = interaction_effect_size)) + 
  geom_point(shape = 21, aes(fill = is_sig_graph, color = is_sig_graph), alpha = 0.8) +
  geom_vline(xintercept = 0, linetype = 2, alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = 2, alpha = 0.5) +
  scale_fill_manual(values = cols2, name = "Interaction") +
  scale_color_manual(values = outline_cols, name = "Interaction") +
  geom_text_repel(data = dplyr::filter(int_dt, significant_interaction, abs(interaction_effect_size) > 0.7),
                  aes(label = featureSymb), color = 'black',
                  size = 3) +
  ylab("Covariate-pseudotime interaction") +
  xlab("Gene regulation over pseudotime") +
  theme(legend.position = 'bottom',
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 11),
        legend.title = element_text(size = 11),
        legend.text = element_text(size = 10)) +
  geom_text(data = textinfo, aes(x = x, y = y, label = label), 
            color = 'black', size = 3, fontface = "bold")


outFile <- file.path(outFolder, paste0("posteriorEffectSizeBeta_vs_pathwayloadingLambda_nicer.", plotType))
ggsave(plot = p, filename = outFile, height=myHeightGG, width=myWidthGG*1.5)
cat(paste0("... written: ", outFile, "\n"))

# stop("ok\n")

############## look at the gene with top and bottom pathway loading ##############

int_dt <- as.data.frame(int_dt)
tmp1 <- as.data.frame(int_dt)
tmp2 <- df_beta
tmp1 <- tmp1[order(tmp1$interaction_effect_size),]
tmp2 <- tmp2[order(tmp2$beta),]
stopifnot(tmp1$featureSymb == tmp2$geneSymb)


p <- plot_iGeneExpr(igene= which.min(int_dt$pathway_loading),
                                 exprdt=ov_data_filteredT,
                                 pseudot=ov_pseudotimes,
                                 covarlab=ifelse(mycovar == 1, "TCGA", "GTEX"),
                                 valuedt=int_dt,
                                             valuecol="pathway_loading", symbcol="featureSymb", subtit=paste0("lowest ", lambdaU))

outFile <- file.path(outFolder, paste0("lowestLambdaGene_expr_along_pseudotime.", plotType))
ggsave(plot = p, filename = outFile, height=myHeightGG, width = myWidthGG*1.2)
cat(paste0("... written: ", outFile, "\n"))

p <- plot_iGeneExpr_gg2(igene= which.min(int_dt$pathway_loading),
                    exprdt=ov_data_filteredT,
                    pseudot=ov_pseudotimes,
                    covarlab=ifelse(mycovar == 1, "TCGA", "GTEX"),
                    valuedt=int_dt,
                    valuecol="pathway_loading", symbcol="featureSymb", subtit=paste0("lowest ", lambdaU))

outFile <- file.path(outFolder, paste0("lowestLambdaGene_expr_along_pseudotime_gg2.", plotType))
ggsave(plot = p, filename = outFile, height=myHeightGG*0.9, width = myWidthGG*1.5)
cat(paste0("... written: ", outFile, "\n"))


p <- plot_iGeneExpr(igene= which.max(int_dt$pathway_loading),
               exprdt=ov_data_filteredT,
               pseudot=ov_pseudotimes,
               covarlab=ifelse(mycovar == 1, "TCGA", "GTEX"),
               valuedt=int_dt,
               valuecol="pathway_loading", symbcol="featureSymb", subtit=paste0("highest ", lambdaU))

outFile <- file.path(outFolder, paste0("highestLambdaGene_expr_along_pseudotime.", plotType))
ggsave(plot = p, filename = outFile, height=myHeightGG, width = myWidthGG*1.2)
cat(paste0("... written: ", outFile, "\n"))


p <- plot_iGeneExpr_gg2(igene= which.max(int_dt$pathway_loading),
                    exprdt=ov_data_filteredT,
                    pseudot=ov_pseudotimes,
                    covarlab=ifelse(mycovar == 1, "TCGA", "GTEX"),
                    valuedt=int_dt,
                    valuecol="pathway_loading", symbcol="featureSymb", subtit=paste0("highest ", lambdaU))

outFile <- file.path(outFolder, paste0("highestLambdaGene_expr_along_pseudotime_gg2.", plotType))
ggsave(plot = p, filename = outFile, height=myHeightGG*0.9, width = myWidthGG*1.5)
cat(paste0("... written: ", outFile, "\n"))

############## top significant pathway loading ##############

# look at the top bottom and up interaction effects
nTop <- 10

# show the top genes with signif interactions
int_dt <- as.data.frame(int_dt)
int_dt <- int_dt[order(int_dt$pathway_loading, decreasing = TRUE),]
topPosGenes <- int_dt[1:nTop,]
topPosGenes$dir <- "pos"
int_dt <- int_dt[order(int_dt$pathway_loading, decreasing = FALSE),]
topNegGenes <- int_dt[1:nTop,]
topNegGenes$dir <- "neg"

dfLambda_topGenes <- rbind(topPosGenes, topNegGenes)
stopifnot(!duplicated(dfLambda_topGenes$feature))
dfLambda_topGenes$feature <- as.character(dfLambda_topGenes$feature)


stopifnot(dfLambda_topGenes$feature %in% gene_lab_dt$geneID_short)
stopifnot(dfLambda_topGenes$feature %in% names(ens2genes))
dfLambda_topGenes$featureSymb <- ens2genes[dfLambda_topGenes$feature]
stopifnot(!duplicated(dfLambda_topGenes$featureSymb))
dfLambda_topGenes$featureSymb <- factor(dfLambda_topGenes$featureSymb, levels=dfLambda_topGenes$featureSymb)
dfLambda_topGenes$dir <- factor(dfLambda_topGenes$dir, levels=c("pos", "neg"))

p <-  ggplot(dfLambda_topGenes, aes(x = featureSymb, y = pathway_loading, color = significant_interaction)) + 
  geom_point() +
  facet_wrap(. ~ dir ,scales="free") +
  ggtitle(paste0("Genes with top pathway loading (", lambdaU, ")"), subtitle=paste0("(", nTop, " lowest and highest)"))+
  # geom_errorbar(aes(ymin = beta - 2 * beta_sd, ymax = beta + 2 * beta_sd)) +
  theme(plot.title = element_text(hjust=0.5),
        plot.subtitle = element_text(hjust=0.5),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title.x = element_blank()) +
  ylab(expression(beta)) +
  scale_color_brewer(palette = "Set2", name = "Significant")

outFile <- file.path(outFolder, paste0("genes_with_top_and_bottom_n", nTop, "_lambda.", plotType))
ggsave(p, filename = outFile, height=myHeightGG, width=myWidthGG*1.2)
cat(paste0("... written: ", outFile, "\n"))

############## PC dots with color-coded by pseudotime gradient ##############

p <- pcaplot_gg2(pca_dt=data.frame(pca_ov_lowrepr), pctoplot=c(2,3), summ_dt=summary(pca_ov),
            condvect = gsub("(^.+?)-.+", "\\1", rownames(pca_ov_lowrepr)),
            colvect=ov_pseudotimes,
            mytit = paste0("TCGA+GTEX OV notNorm (log2(.+1))"),
            mysubtit = paste0("nGTEX=",nGTEX, "; nTCGA=",nTCGA))

outFile <- file.path(outFolder, paste0("in_raw_data_pca_23_pseudotimeGrad_tcga_gtex.", plotType))
ggsave(p, filename = outFile, height=myHeightGG*0.9, width=myWidthGG*1.5)
cat(paste0("... written: ", outFile, "\n"))


p <- pcaplot_gg2(pca_dt=data.frame(pca_ov_lowrepr), pctoplot=c(1,2), summ_dt=summary(pca_ov),
            condvect = gsub("(^.+?)-.+", "\\1", rownames(pca_ov_lowrepr)),
            colvect=ov_pseudotimes,
            mytit = paste0("TCGA+GTEX OV notNorm (log2(.+1))"),
            mysubtit = paste0("nGTEX=",nGTEX, "; nTCGA=",nTCGA))

outFile <- file.path(outFolder, paste0("in_raw_data_pca_12_pseudotimeGrad_tcga_gtex.", plotType))
ggsave(p, filename = outFile, height=myHeightGG*0.9, width=myWidthGG*1.5)
cat(paste0("... written: ", outFile, "\n"))



p <- pcaplot_gg2(pca_dt=data.frame(pca_ov_lowrepr), pctoplot=c(1,3), summ_dt=summary(pca_ov),
                 condvect = gsub("(^.+?)-.+", "\\1", rownames(pca_ov_lowrepr)),
                 colvect=ov_pseudotimes,
                 mytit = paste0("TCGA+GTEX OV notNorm (log2(.+1))"),
                 mysubtit = paste0("nGTEX=",nGTEX, "; nTCGA=",nTCGA))

outFile <- file.path(outFolder, paste0("in_raw_data_pca_13_pseudotimeGrad_tcga_gtex.", plotType))
ggsave(p, filename = outFile, height=myHeightGG*0.9, width=myWidthGG*1.5)
cat(paste0("... written: ", outFile, "\n"))
############## gene set enrichment on top and bottom beta value genes ##############


# A GO enrichment analysis of the genes upregulated along pseudotime whose upregulation was increased by LPS stimulation
# showed enrichment for immune system processes.
# do GO enrichment analysis of the top upregulated along pseudotime for cond=+1 et cond=-1 separately
# GO category vs. p-value with colorcond by condvar

# compare to common c 
# A GO enrichment analysis of upregulated genes confirms the latent trajectory encodes immune pathway activation in each tumour

# in the case of COAD -> was common trajectory
# in the case of LS/PAM -> was different

# I think the following would be of interest
# the highest/lowest betas => this would give the ones with highest interaction effects up/down regulated normal/tumor
# the highest/lowest lambda => the one most up/down regulated across pseudotimes


# What is pseudotime?  - GO association
# from: https://github.com/kieranrcampbell/phenopath_analyses/blob/master/analysis/BRCA/clvm_analysis_er_pos.Rmd


pp_input_data <- ov_data_filteredT

all_genes <- colnames(pp_input_data) # ensemblID
corr_expr_pt <- apply(pp_input_data, 2, cor, ov_pseudotimes)
cdf <- data.frame(feature = all_genes, 
                  correlation = corr_expr_pt)
stopifnot(!is.na(cdf))

outFile <- file.path(outFolder, paste0("corr_gene_expr_pseudot_distribution_all.", plotType))
do.call(plotType, list(outFile, height=myHeight, width=myWidth))
plot(density(cdf$correlation), main="corr. gene expr. and pseudotimes")
mtext(side=3, text="(all samples; # = ", nrow(cdf), ")")
foo <- dev.off()
cat(paste0("... written: ", outFile, "\n"))

stopifnot(length(ov_pseudotimes) == nrow(pp_input_data))

tcga_samp <- grep("^TCGA", rownames(pp_input_data))
stopifnot(length(tcga_samp) == nTCGA)
corr_expr_pt_tcga <- apply(pp_input_data[tcga_samp,], 2, cor, ov_pseudotimes[tcga_samp])
cdf_tcga <- data.frame(feature = all_genes, 
                  correlation = corr_expr_pt_tcga)
stopifnot(!is.na(cdf_tcga))

gtex_samp <- grep("^GTEX", rownames(pp_input_data))
stopifnot(length(gtex_samp) == nGTEX)
corr_expr_pt_gtex <- apply(pp_input_data[gtex_samp,], 2, cor, ov_pseudotimes[gtex_samp])
to_keep <- which(!is.na(corr_expr_pt_gtex))  ### there is 2 genes with all 0 values !!! -> cannot compute corr
cdf_gtex <- data.frame(feature = all_genes[to_keep], 
                       correlation = corr_expr_pt_gtex[to_keep])
stopifnot(!is.na(cdf_gtex))


outFile <- file.path(outFolder, paste0("corr_gene_expr_pseudot_distribution.", plotType))
do.call(plotType, list(outFile, height=myHeight, width=myWidth))
plot(density(cdf_tcga$correlation), main="corr. gene expr. and pseudotimes", col=2)
lines(density(cdf_gtex$correlation), col=1)
legend("topright", legend=c("GTEX", "TCGA"), pch=16, col=c(1,2), bty="n")
mtext(side=3, text=paste0("(# GTEX=", nGTEX, "; # TCGA=", nTCGA, ")"))
foo <- dev.off()
cat(paste0("... written: ", outFile, "\n"))


stopifnot(topCorrThresh >= 0)
upreg_genes <- cdf$feature[cdf$correlation > topCorrThresh]
downreg_genes <- cdf$feature[cdf$correlation < -topCorrThresh]
upg <- 1 * (all_genes %in% upreg_genes)
downg <- 1 * (all_genes %in% downreg_genes)
names(upg) <- names(downg) <- all_genes
pwfup <- nullp(upg, genome, id) # nullp = Probability Weighting Function from goseq
goup <- goseq(pwfup, genome, id, test.cats = go_cat)
pwfdown <- nullp(downg, genome, id)
godown <- goseq(pwfdown, genome, id, test.cats = go_cat)


corrExpr_gos <- rbind(
  parse_go(goup, "Up-regulated", length(upreg_genes), plotntop=plotNgos),
  parse_go(godown, "Down-regulated", length(downreg_genes), plotntop=plotNgos)
)

corrExpr_gos$term <- factor(corrExpr_gos$term, levels = corrExpr_gos$term[order(corrExpr_gos$log10qval)])

p <- ggplot(corrExpr_gos, aes(x = term, y = log10qval)) +
  geom_point() +
  ggtitle(paste0("Top ", plotNgos, " GOs"), subtitle = paste0("(abs. corr. with Pseudotime > ", topCorrThresh, ")"))+
  facet_wrap(~ type, scales = "free", nrow = 2) +
  coord_flip() +
  theme(axis.title.y = element_blank(), legend.position = "none") +
  ylab(expression(paste("-", log[10], " q-value"))) +
  theme(
    plot.title = element_text(hjust=0.5),
    plot.subtitle = element_text(hjust=0.5),
    legend.position = c(0, 0), legend.direction = "horizontal",
    axis.text = element_text(size = 8),
    axis.title = element_text(size = 10),
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10)) 

outFile <- file.path(outFolder, paste0("topCorrExpr_topGOs.", plotType))
ggsave(p, filename = outFile, height=myHeightGG*1.4, width=myWidthGG*1.5)
cat(paste0("... written: ", outFile, "\n"))


  
### Do the same for top beta:

stopifnot(topBetaThresh >= 0)

df_beta$ensembl_gene_id <- df_beta$gene
upreg_genes <- df_beta$ensembl_gene_id[df_beta$beta > topBetaThresh & df_beta$is_sig]
downreg_genes <- df_beta$ensembl_gene_id[df_beta$beta < -topBetaThresh & df_beta$is_sig]

upg <- 1 * (all_genes %in% upreg_genes)
downg <- 1 * (all_genes %in% downreg_genes)
names(upg) <- names(downg) <- all_genes
pwfup <- nullp(upg, genome, id)
goup <- goseq(pwfup, genome, id, test.cats = go_cat)
pwfdown <- nullp(downg, genome, id)
godown <- goseq(pwfdown, genome, id, test.cats = go_cat)

betacorr_gos <- rbind(
  parse_go(goup, "Up-regulated", length(upreg_genes), plotNgos),
  parse_go(godown, "Down-regulated", length(downreg_genes), plotNgos)
)


betacorr_gos$term <- factor(betacorr_gos$term, levels = betacorr_gos$term[order(betacorr_gos$log10qval)])

p <- ggplot(betacorr_gos, aes(x = term, y = log10qval, color = type)) +
  ggtitle(paste0("Top ", plotNgos," GOs"), 
          subtitle = paste0("abs(", betaU, ")>", topBetaThresh, 
                            " & signif. (#up=",length(upreg_genes) ,"; #down=", length(downreg_genes) , ")"))+
  geom_point() +
  facet_wrap(~ type, scales = "free", nrow = 2) +
  coord_flip() +
  theme(axis.title.y = element_blank(), legend.position = "none") +
  scale_color_brewer(palette = "Set1") +
  ylab(expression(paste(log[10], " q-value"))) +
  theme(axis.text = element_text(size = 10),
        axis.title.x = element_text(size = 11))

outFile <- file.path(outFolder, paste0("topBeta_topGOs.", plotType))
ggsave(p, filename = outFile, height=myHeightGG*1.4, width=myWidthGG*1.5)
cat(paste0("... written: ", outFile, "\n"))


# for reactome pathway analysis
# https://github.com/kieranrcampbell/phenopath_revisions/blob/master/analysis/ov_reanalysis/clvm_analysis.Rmd

############## complementary info to std gene DE ##############

# look at genes that are differentially expressed (large difference of gene expression normal vs. tumor)
# and that have different trajectories (high interaction effects)
# Whilst many of these 92 genes are differentially expressed between MSI groups, including MLH2 and TGFBR2 (Fig. 5c), 
# PhenoPath is able to resolve the dynamic contribution to these expression differences


# see e.g. http://research.libd.org/recountWorkflow/articles/recount-workflow.html
# ov_data_raw comes from here:
# ovary_gtex <- scale_counts(TCGAquery_recount2(project="gtex", tissue = "ovary")$gtex_ovary)
# ovary_tcga <- scale_counts(TCGAquery_recount2(project="tcga", tissue = "ovary")$tcga_ovary)
# # I skip some steps of processing, but I have in the end 
# # gene x sample matrix with GTEX samples starting with GTEX- and TCGA samples with TCGA-
# ovary_all_data <- cbind(assays(ovary_gtex)$counts, assays(ovary_tcga)$counts)

ov_data_raw <- get(load(file.path(inFolder, paste0("all_counts_onlyPF_", purityFilter, ".Rdata"))))

# filter because I have removed the outlier !
stopifnot(tcga_annot_dt$cgc_sample_id %in% colnames(ov_data_raw))
stopifnot(gtex_annot_dt$sampid %in% colnames(ov_data_raw))
stopifnot(!duplicated(tcga_annot_dt$cgc_sample_id))
stopifnot(!duplicated(gtex_annot_dt$sampid))
ov_data_raw <- ov_data_raw[, c(gtex_annot_dt$sampid, tcga_annot_dt$cgc_sample_id) ]

# remove the weird gene
tokeep <- ! grepl("_PAR_Y$", rownames(ov_data_raw))
cat(paste0("... remove weird genes: ", sum(!tokeep), "/", length(tokeep), "\n"))
ov_data_raw <- ov_data_raw[tokeep,]
stopifnot(!duplicated(gsub("\\..*", "",rownames(ov_data_raw))))


## Extract counts and filter out lowly expressed geens

to_keep <- rowMeans(ov_data_raw) > meanExprThresh_limma
cat(paste0("... keep sufficient expr: ", sum(to_keep), "/", length(tokeep), "\n"))


## Build DGEList object
dge <- DGEList(counts = ov_data_raw[to_keep, ])
## Calculate normalization factors
dge <- calcNormFactors(dge)
# plotMDS(dge)
samples_groups <- c(rep("normal", nrow(gtex_annot_dt)), rep("tumor", nrow(tcga_annot_dt)))
my_group_design <- factor(samples_groups, levels = c("normal", "tumor"))
my_design <- model.matrix( ~ my_group_design)
## Run voom
v <- voom(dge, my_design, plot = TRUE)
## Run remaining parts of the DE analysis
fit <- lmFit(v, my_design)
efit <- eBayes(fit)

## Visually explore DE results
# limma::plotMA(efit)
# limma::volcanoplot(efit)

DE_topTable <- topTable(efit, coef=ncol(v$design), number=Inf, sort.by="p") ## if not 0+ in design -> coef=2


stopifnot(!duplicated(rownames(gsub("\\..*", "",rownames(ov_data_raw)))))

DE_topTable$ensemblID <- gsub("\\..*", "",rownames(DE_topTable))
stopifnot(!duplicated(DE_topTable$ensemblID))

## look for genes that has high logFC + has high beta value

nTopDEvalueThresh <- 800
topDEvalueThresh <- sort(abs(DE_topTable$logFC), decreasing = TRUE)[nTopDEvalueThresh]
topDEvalueThresh

topLogFC_genes <- DE_topTable$ensemblID[abs(DE_topTable$logFC) >= topDEvalueThresh]

nTopBetaValueThresh <- 800
topBetaValueThresh <- sort(abs(df_beta$beta), decreasing = TRUE)[nTopBetaValueThresh]
topBetaValueThresh
topBeta_genes <- df_beta$gene[abs(df_beta$beta) >= topBetaValueThresh]

intersect(topLogFC_genes, topBeta_genes)

# not convincing -> up to 500, no intersect

############## gene limma voom pvalue vs. phenopath beta value  ##############

df_beta$ensemblID <- df_beta$gene

merged_dt <- merge(df_beta, DE_topTable, by="ensemblID", all.x = TRUE, all.y=FALSE)
stopifnot(!is.na(merged_dt))

outFile <- file.path(outFolder, "merged_dt.Rdata")
save(merged_dt, file=outFile)
cat(paste0("... written: ", outFile, "\n"))

outFile <- file.path(outFolder, "DE_topTable.Rdata")
save(DE_topTable, file=outFile)
cat(paste0("... written: ", outFile, "\n"))

outFile <- file.path(outFolder, paste0("limma_adjPval_vs_phenopath_beta.", plotType))
do.call(plotType, list(outFile, height=myHeight, width=myWidth))
plot(
  y=-log10(merged_dt$adj.P.Val),
  x=merged_dt$beta,
  pch=16,
  col=2+2*merged_dt$is_sig,
  cex.lab=1.2,
  cex.axis=1.2,
  ylab="limma adj. Pval [-log10]",
  xlab=paste0("Phenopath ", betaU)
)
legend("topright", legend=c("signif.", "not signif."),
       pch=16,bty="n",
       col = c(2+2*c(TRUE, FALSE)))

foo <- dev.off()
cat(paste0("... written: ", outFile, "\n"))

##### NICER WAY with colors as in 
# https://github.com/kieranrcampbell/phenopath_revisions/blob/master/analysis/brca_reanalysis/clvm_analysis.Rmd
cols <- RColorBrewer::brewer.pal(3, "Set2")
cols2 <- c("#c5e2d9", cols[2])
p <- ggplot(merged_dt, aes(x = beta, y =-log10(adj.P.Val), color = is_sig)) + 
  geom_point() +
  ylab(expression(paste("limma voom -", log[10], "(adj. P-value)"))) + 
  xlab(expression(paste("Phenopath ", beta))) +
  # theme(legend.position = 'top') +
  geom_hline(yintercept = -log10(0.05), linetype = 2, alpha = 0.5) +
  theme(axis.text = element_text(size = 9),
        axis.title = element_text(size = 10)) +
  #theme(legend.title = element_text(size = 10),
  #      legend.text = element_text(size = 9)) +
  theme(legend.position = "none") +
  scale_color_manual(values = cols2, name = "Interaction") 
p <- ggExtra::ggMarginal(p, margins = "y", type = "histogram", size = 10)

outFile <- file.path(outFolder, paste0("nicer_limma_adjPval_vs_phenopath_beta.", plotType))
ggsave(p, filename = outFile, height=myHeightGG, width=myWidthGG*1.2)
cat(paste0("... written: ", outFile, "\n"))


outFile <- file.path(outFolder, paste0("limma_logFC_vs_phenopath_beta.", plotType))
do.call(plotType, list(outFile, height=myHeight, width=myWidth))
plot(
  y=merged_dt$logFC,
  x=merged_dt$beta,
  pch=16,
  col=2+2*merged_dt$is_sig,
  cex.lab=1.2,
  cex.axis=1.2,
  ylab="limma logFC",
  xlab=paste0("Phenopath ", betaU)
)
legend("topright", legend=c("signif.", "not signif."),
       pch=16,bty="n",
       col = c(2+2*c(TRUE, FALSE)))

foo <- dev.off()
cat(paste0("... written: ", outFile, "\n"))


stopifnot(ov_phenopath_fit$m_beta[1,] == df_beta$beta)
stopifnot(ov_phenopath_fit$feature_names == df_beta$gene)

df_beta$alpha <- ov_phenopath_fit$m_alpha[1,]
df_beta$crossover <- -df_beta$alpha/df_beta$beta
stopifnot(!is.na(df_beta))
df_beta_sig <- df_beta[df_beta$is_sig,]

mytit <- paste0("Crossover points distribution")
subtit <- paste0("only signif. genes (n=", nrow(df_beta_sig), ")")
med_val <- median(df_beta_sig$crossover)

p <- ggplot(df_beta_sig, aes(x = crossover)) + 
  ggtitle(paste0(mytit), subtitle=paste0(subtit))+
  geom_histogram(fill = "#74a9cf", color = "grey90", bins = 30) +
  xlab("Crossover point") + ylab("Number of genes") + 
  geom_vline(xintercept = med_val, linetype=2)+
  scale_y_continuous(expand = expansion(mult = c(0, 0.1))) +
  theme(
    # plot.title = element_text(hjust=0.5),
    # plot.subtitle = element_text(hjust=0.5),
    panel.background = element_blank(),
    axis.line=element_line(),
    axis.text = element_text(size = 9),
    axis.title = element_text(size = 10))

max_val <- max(ggplot_build(p)$data[[1]]$count)
p <- p + annotate("text", label=paste0("median = ", round(med_val, 3)),
                  x=median(df_beta_sig$crossover) -0.1,
                  y = max_val, hjust=1)

outFile <- file.path(outFolder, paste0("signifGenes_crossoverPointsDistribution.", plotType))
ggsave(p, filename = outFile, height=myHeightGG, width=myWidthGG*1.4)
cat(paste0("... written: ", outFile, "\n"))



##################################################
cat(paste0("****** DONE"))
cat(paste0(startTime, " - ", Sys.time(),  "\n"))
stop("--ok\n")

####################################################################################################
### THRASH
####################################################################################################


# TCGA annot of interest

# [1] "cgc_file_platform"
# Illumina HiSeq 
# 430 
# [1] "cgc_file_investigation"
# TCGA-OV 
# 430 
# [1] "cgc_file_disease_type"
# Ovarian Serous Cystadenocarcinoma 
#                               430 
# [1] "cgc_sample_sample_type"
#   Primary Tumor Recurrent Tumor 
#             422               8 
# [1] "cgc_case_vital_status"
# Alive  Dead 
#   192   237 
# [1] "cgc_case_primary_site"
# Ovary 
#   430 
# [1] "cgc_case_clinical_stage"
# 
#   Stage IC  Stage IIA  Stage IIB  Stage IIC Stage IIIA Stage IIIB Stage IIIC   Stage IV 
#          1          3          5         18          7         18        311         64 
# [1] "cgc_case_gender"
# FEMALE 
#    430 
# [1] "cgc_drug_therapy_pharmaceutical_therapy_type"
# 
#               Chemotherapy            Hormone Therapy              Immunotherapy 
#                        376                          6                          2 
# Targeted Molecular therapy 
# 7 



# 
# for(i in colnames(tcga_annot_dt)) {
#   x <- table(tcga_annot_dt[,i])
#   if(length(x) <= 10) {
#     print(i)
#     print(x)
#   }
# }



# sc$plate <- droplevels(sc$plate)
# batch <- sc$plate
# design <- model.matrix(~ 1, data = pData(sc))
# exprs_combat <- ComBat(exprs(sc), batch, design)
# exprs(sc) <- exprs_combat
# Subset to those with mutations:

# make each sample to have the same range of expression
dim(tcga_data_log)
# [1] 25224   430
tcga_data_log_norm <- apply(tcga_data_log, 2, function(x) (x- min(x)) / (max(x)- min(x)))
gtex_data_log_norm <- apply(gtex_data_log, 2, function(x) (x- min(x)) / (max(x)-min(x)))

ov_data_log_norm <- cbind(tcga_data_log_norm, gtex_data_log_norm)
pca_ov_norm <- prcomp(t(ov_data_log_norm), scale=TRUE)
pca_ov_norm_lowrepr <- pca_ov_norm$x
stopifnot(nrow(pca_ov_norm_lowrepr) == nGTEX+nTCGA)

dev.off()
plot(x = pca_ov_norm_lowrepr[,1],
     y = pca_ov_norm_lowrepr[,2],
     xlab="PC1", ylab="PC2",
     main="TCGA+GTEX OV (log2(.+1))",
     pch=16,
     col=1+as.numeric(grepl("TCGA", rownames(pca_ov_norm_lowrepr))))
mtext(text=paste0("nGTEX=",nGTEX, "; nTCGA=",nTCGA), side=3)
legend("topleft", legend=c("GTEX", "TCGA"), pch=16, col=c(1,2), bty="n")



stopifnot(colnames(ov_data_filteredT) %in% gene_lab_dt$geneID_short)  

unique(sapply(colnames(ov_data_filteredT), function(x) sum(x %in% gene_lab_dt$geneID_short)))
# [1] 1   # there is no ambiguity in gene name
sub_gene_lab_dt <- gene_lab_dt[gene_lab_dt$geneID_short %in% colnames(ov_data_filteredT), ]
sub_gene_lab_dt$mapping_source <- NULL
sub_gene_lab_dt <- unique(sub_gene_lab_dt)
any(duplicated(sub_gene_lab_dt$geneID_short))
any(duplicated(sub_gene_lab_dt$geneSymb))

sub_gene_lab_dt[sub_gene_lab_dt$geneID_short == df_beta$gene[which_largest],]
# PLXNC1 -> tumor suppressor gene !





df_large <- data.frame(
  y = ov_data_filteredT[, which_lowest],
  x = mycovar,
  z = ov_pseudotimes
)

#dev.off()
df_large$covar_lab <- ifelse(mycovar == 1, "TCGA", "GTEX")

p <- ggplot(df_large, aes(x = z, y = y, color = covar_lab))+
  geom_point() +
  ylab("Expression (GCnorm + log2(.+1))") +
  xlab("PP Pseudotimes")+
  ggtitle(paste0("",beta_topGene ), subtitle=paste0("highest beta (", round(df_beta$beta[which_lowest], 3), ")"))+
  labs(color="")+
  scale_color_brewer(palette = "Set1") +
  stat_smooth()+
  theme(plot.title = element_text(hjust=0.5),
        plot.subtitle = element_text(hjust=0.5))


which_largest <- which.max(df_beta$beta)
beta_topGene <- df_beta$geneSymb[which_largest]

df_large <- data.frame(
  y = ov_data_filteredT[, which_largest],
  x = mycovar,
  z = ov_pseudotimes
)

#dev.off()
df_large$covar_lab <- ifelse(mycovar == 1, "TCGA", "GTEX")

p <- ggplot(df_large, aes(x = z, y = y, color = covar_lab))+
  geom_point() +
  ylab("Expression (GCnorm + log2(.+1))") +
  xlab("PP Pseudotimes")+
  ggtitle(paste0("",beta_topGene ), subtitle=paste0("highest beta (", round(df_beta$beta[which_largest], 3), ")"))+
  labs(color="")+
  scale_color_brewer(palette = "Set1") +
  stat_smooth()+
  theme(plot.title = element_text(hjust=0.5),
        plot.subtitle = element_text(hjust=0.5))


df_curve <- frame_data(
  ~ ER_status, ~ x, ~ xend, ~ y, ~ yend, ~ curvature,
  "ER-positive", -50, 20, 27, 40, 0.1,
  "ER-negative", 55, 60, -35, 40, -0.1
)
geom_curve(aes(x = x, y = y, xend = xend, yend = yend),
           data = filter(df_curve, ER_status == "ER-negative"), color = 'black',
           curvature = df_curve$curvature[2], arrow = arrow(length = unit(0.3, "cm"), type = "open"), 
           size = 1.5) +
  
  
df_curve$ER_status <- factor(df_curve$ER_status, levels = df_curve$ER_status)
plt <- filter(df_pca, ER_status != "indeterminate") %>% 
  ggplot(aes(x = PC2, y = PC3)) +
  geom_point(data = df_no_er, fill = "grey80", color = "grey80", size = 3) +
  geom_point(aes(fill = pseudotime), shape = 21, color = 'grey20', size = 3) +
  scale_fill_viridis(name = "Pseudotime", option = "C") + 
  facet_wrap(~ ER_status) +
  theme(legend.position = c(.4,.08),
        legend.direction = "horizontal") +
  geom_curve(aes(x = x, y = y, xend = xend, yend = yend),
             data = filter(df_curve, ER_status == "ER-negative"), color = 'black',
             curvature = df_curve$curvature[2], arrow = arrow(length = unit(0.3, "cm"), type = "open"), 
             size = 1.5) +
  geom_curve(aes(x = x, y = y, xend = xend, yend = yend),
             data = filter(df_curve, ER_status == "ER-positive"), color = 'black',
             curvature = df_curve$curvature[1], arrow = arrow(length = unit(0.3, "cm"), type = "open"), 
             size = 1.5) +
  theme(strip.background = element_rect(fill = "grey95", color = "grey30", size = 1),
        legend.text = element_text(size = 8),
        axis.text = element_text(size = 9),
        axis.title = element_text(size = 10),
        legend.title = element_text(size = 10)) +
  xlim(-72, 83) + ylim(-50, 50)
```



Time for some reactome fun:
  
  ```{r reactome-time}
pathways <- c("1643713", "1226099",
              "2219528", "2644603",
              "3304351", "4791275")
id_to_name <- as.list(reactomePATHID2NAME)
pathway_names <- id_to_name[pathways]
pathways_to_genes <- as.list(reactomePATHID2EXTID)
gene_list <- pathways_to_genes[pathways]
pathway_names <- sapply(pathway_names, function(pn) {
  gsub("Homo sapiens: ", "", pn)
})
names(gene_list) <- pathway_names
mart <- useMart("ensembl", "hsapiens_gene_ensembl")
to_ensembl <- function(gl) {
  bm <- getBM(attributes = c("ensembl_gene_id", "hgnc_symbol"),
              filters = c("entrezgene"),
              values = as.numeric(gl),
              mart = mart)
  return(bm$ensembl_gene_id)
}
gene_list_ensembl <- lapply(gene_list, to_ensembl)
```

And graph the results for various metrics:
  
  ```{r graph-for-metrics, eval = FALSE}
sce <- readRDS("../../data/ov/sce_ov_gene_level.rds")
all_genes <- unique(unlist(gene_list_ensembl))
all_genes <- all_genes[all_genes %in% fData(sce)$ensembl_gene_id]
mm <- match(all_genes, fData(sce)$ensembl_gene_id)
is_basal <- sce$PAM50_mRNA == "Basal-like"
Y <- t(exprs(sce)[mm, ])
colnames(Y) <- all_genes
df_gex <- Y %>% 
  as_data_frame() %>% 
  dplyr::mutate(is_basal, z = pData(sce)[['tmap']]) %>% 
  gather(gene, expression, -is_basal, -z)
df_pheno <- bind_rows(
  lapply(names(gene_list_ensembl), function(n) {
    data_frame(pathway = n, gene = gene_list_ensembl[[n]])
  })
)
df <- inner_join(df_gex, df_pheno, by = 'gene')
df2 <- filter(df, !is.na(is_basal)) %>% 
  group_by(gene, pathway, is_basal) %>% 
  summarise(gex = mean(expression))
df3 <- df %>% # filter(df, !is.na(is_basal)) %>% 
  group_by(pathway, z) %>% 
  summarise(gex = median(expression))
ggplot(df3, aes(x = z, y = gex)) + 
  geom_point(alpha = 0.7) + 
  facet_wrap(~ pathway, scales = 'free_y') +
  ylab("Median pathway expression") +
  stat_smooth(color = 'red', se = F)


